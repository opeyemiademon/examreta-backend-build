import fs from"fs";import path from"path";import{v4 as uuidv4}from"uuid";export const ALLOWED_IMAGE_TYPES=["image/jpeg","image/png","image/gif","image/webp"];export const ALLOWED_DOCUMENT_TYPES=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/msword"];export const MAX_FILE_SIZE=52428800;export const UPLOAD_DIRS={PROFILE_PICTURES:"photos",DOCUMENTS:"documents",ATTACHMENTS:"attachments",PROJECTS:"projects",PDFS:"pdfs"};const UPLOAD_DIR=path.join(process.cwd(),"images"),PROFILE_PICTURES_DIR=path.join(UPLOAD_DIR,"photos");export const ensureDirectoriesExist=e=>{if(fs.existsSync(UPLOAD_DIR)||fs.mkdirSync(UPLOAD_DIR,{recursive:!0}),fs.existsSync(PROFILE_PICTURES_DIR)||fs.mkdirSync(PROFILE_PICTURES_DIR,{recursive:!0}),e){const t=path.join(UPLOAD_DIR,e);fs.existsSync(t)||fs.mkdirSync(t,{recursive:!0})}};export const processBase64Upload=async(e,t,s,o)=>{ensureDirectoriesExist(t);try{const i=e.match(/^data:([^;]+);base64,/);if(!i)throw new Error("Invalid base64 data format");const r=i[1];if(!s.includes(r))throw new Error(`Invalid file type. Allowed types: ${s.join(", ")}`);let n="";switch(r){case"application/pdf":n=".pdf";break;case"application/vnd.openxmlformats-officedocument.wordprocessingml.document":n=".docx";break;case"application/msword":n=".doc";break;case"image/jpeg":n=".jpg";break;case"image/png":n=".png";break;case"image/gif":n=".gif";break;case"image/webp":n=".webp";break;default:n=".bin"}const a=uuidv4(),c=o?`${o}-${a}${n}`:`${a}${n}`,p=path.join(UPLOAD_DIR,t),m=path.join(p,c),f=e.replace(/^data:[^;]+;base64,/,""),d=Buffer.from(f,"base64");if(d.length>52428800)throw new Error("File size exceeds the maximum limit of 50MB");return fs.writeFileSync(m,d),c}catch(e){throw e}};export const processProfilePictureUpload=async(e,t)=>{ensureDirectoriesExist();try{const{createReadStream:s,filename:o,mimetype:i}=await e;if(!ALLOWED_IMAGE_TYPES.includes(i))throw new Error(`Invalid file type. Allowed types: ${ALLOWED_IMAGE_TYPES.join(", ")}`);const r=generateSecureFilename(o,t),n=path.join(PROFILE_PICTURES_DIR,r),a=fs.createWriteStream(n);return new Promise((e,t)=>{let o=0;const i=s();i.on("data",e=>{if(o+=e.length,o>52428800)return i.destroy(),a.destroy(),fs.existsSync(n)&&fs.unlinkSync(n),void t(new Error("File size exceeds the maximum limit of 50MB"))}),i.pipe(a).on("finish",()=>{e(`/images/photos/${r}`)}).on("error",e=>{fs.existsSync(n)&&fs.unlinkSync(n),t(e)})})}catch(e){throw e}};export const deleteFile=e=>{const t=path.join(process.cwd(),e.replace(/^\//,""));fs.existsSync(t)&&fs.unlinkSync(t)};export const generateSecureFilename=(e,t)=>{const s=path.extname(e).toLowerCase();return`${t}-${Date.now()}-${uuidv4().slice(0,8)}${s}`};