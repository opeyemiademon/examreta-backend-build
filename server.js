import{ApolloServer}from"@apollo/server";import{expressMiddleware}from"@as-integrations/express5";import express from"express";import mongoose from"mongoose";import cors from"cors";import bodyParser from"body-parser";import dotenv from"dotenv";import path from"path";import{schema}from"./schema.js";import{ensureDirectoriesExist}from"./utils/fileUpload.js";import{getAuthContext}from"./middleware/auth.js";const simpleErrorHandler=(e,o,r,t)=>{console.error("Error:",e),r.status(500).json({success:!1,message:e.message||"Internal server error",..."development"===process.env.NODE_ENV&&{stack:e.stack}})},notFoundHandler=(e,o)=>{o.status(404).json({success:!1,message:`Resource not found - ${e.originalUrl}`})};async function connectToDatabase(){try{return await mongoose.connect("mongodb+srv://root:root@cluster0.48unr.mongodb.net/examreta_db?retryWrites=true&w=majority"),console.log("✅ Connected to MongoDB successfully"),mongoose.connection.on("error",e=>{console.error("❌ MongoDB connection error:",e)}),mongoose.connection.on("disconnected",()=>{console.warn("⚠️ MongoDB disconnected")}),process.on("SIGINT",async()=>{await mongoose.connection.close(),console.log("MongoDB connection closed due to app termination"),process.exit(0)}),!0}catch(e){return console.error("❌ Failed to connect to MongoDB:",e),!1}}async function initServer(){await connectToDatabase()||console.warn("⚠️ MongoDB connection failed, but continuing to start server...");const e=express();e.use(cors({origin:(e,o)=>{o(null,e||"*")},credentials:!0,methods:["GET","POST","PUT","DELETE","OPTIONS","PATCH"],allowedHeaders:["Content-Type","Authorization","X-Requested-With","Accept","Origin"],exposedHeaders:["Content-Length","X-JSON"],maxAge:86400,preflightContinue:!1,optionsSuccessStatus:204})),e.use((e,o,r)=>{if(o.header("Access-Control-Allow-Origin",e.headers.origin||"*"),o.header("Access-Control-Allow-Credentials","true"),o.header("Access-Control-Allow-Methods","GET,POST,PUT,DELETE,OPTIONS,PATCH"),o.header("Access-Control-Allow-Headers","Content-Type, Authorization, X-Requested-With, Accept, Origin"),"OPTIONS"===e.method)return o.sendStatus(204);r()}),e.use(bodyParser.json({limit:"50mb"})),e.use(bodyParser.urlencoded({limit:"50mb",extended:!0})),ensureDirectoriesExist(),e.use("/images",express.static(path.join(process.cwd(),"images"))),e.use((e,o,r)=>{console.log(`${(new Date).toISOString()} - ${e.method} ${e.originalUrl}`),r()});const o=new ApolloServer({schema:schema,formatError:e=>(console.error("GraphQL Error:",e),{message:e.message,path:e.path,extensions:{code:e.extensions?.code||"INTERNAL_SERVER_ERROR",..."development"===process.env.NODE_ENV&&{stacktrace:e.extensions?.stacktrace}}})});await o.start(),e.use("/graphql",expressMiddleware(o,{context:async({req:e})=>{const o=e.headers.authorization||"";try{return{...await getAuthContext(o),req:e}}catch(o){return{isAuthenticated:!1,authError:o.message,req:e}}}})),e.get("/",(e,o)=>{o.send("Examreta server API - Running")}),e.use(simpleErrorHandler);const r=parseInt(process.env.PORT??"8000",10);e.listen(r,"0.0.0.0",()=>{console.log(`✅ Server is running on http://localhost:${r}`),console.log(`✅ GraphQL endpoint: http://localhost:${r}/graphql`)})}dotenv.config(),initServer().catch(e=>{console.error("❌ Failed to start server:",e),process.exit(1)});