import jwt from"jsonwebtoken";import{include}from"../settings.js";import{GraphQLError}from"graphql";import Staff from"../modules/staff/staff.model.js";import Student from"../modules/student/student.model.js";class AuthenticationError extends GraphQLError{constructor(t){super(t,{extensions:{code:"UNAUTHENTICATED"}})}}export const extractTokenFromHeader=t=>{if(!t)return null;if(!t.startsWith("Bearer "))return null;return t.substring(7)||null};export const verifyJWTToken=t=>{try{return jwt.verify(t,include.TOKEN_SECRET)}catch(t){return t instanceof jwt.TokenExpiredError?(console.log("Token has expired"),{status:401,message:"Token has expired"}):t instanceof jwt.JsonWebTokenError?(console.log("Invalid token"),{status:401,message:"Invalid token"}):(console.log("Token verification failed"),{status:401,message:"Token verification failed"})}};export const getUserFromToken=async t=>{try{const e=await Staff.findById(t.id).populate("school").select("-password");if(!e||e.is_deleted)throw new AuthenticationError("User not found or has been deleted");return{id:e._id.toString(),email_address:e.email_address||"",school:e.school||"",fullname:e.fullname||""}}catch(t){if(t instanceof AuthenticationError)throw t;throw new AuthenticationError("User not found or has been deleted")}};export const getAuthContext=async t=>{const e=extractTokenFromHeader(t);if(!e)return{isAuthenticated:!1};try{const t=verifyJWTToken(e),n=await getUserFromToken(t);if(!n)throw new AuthenticationError("User not found or has been deleted");return{user:n,isAuthenticated:!0}}catch(t){if(t instanceof AuthenticationError)throw t;throw new AuthenticationError("Authentication failed")}};export const requireAuth=t=>{if(!t.isAuthenticated||!t.user)throw new AuthenticationError("You must be logged in to perform this action");return t.user};export const getStudentFromToken=async t=>{try{const e=await Student.findById(t.id);if(!e||e.is_deleted)throw new AuthenticationError("Student not found or has been deleted");if(e.isBlocked)throw new AuthenticationError("Student account is blocked"+(e.blockReason?": "+e.blockReason:""));return{id:e._id.toString(),email:e.email||"",firstName:e.firstName||"",lastName:e.lastName||"",examKey:e.examKey,exam:e.exam||null,school:e.school||null,studentNumber:e.studentNumber||"",class:e.class||""}}catch(t){if(t instanceof AuthenticationError)throw t;throw new AuthenticationError("Student not found or has been deleted")}};export const getStudentAuthContext=async t=>{const e=extractTokenFromHeader(t);if(!e)return{isAuthenticated:!1};try{const t=verifyJWTToken(e);if(401===t.status)throw new AuthenticationError(t.message||"Authentication failed");const n=await getStudentFromToken(t);if(!n)throw new AuthenticationError("Student not found or has been deleted");return{student:n,isAuthenticated:!0}}catch(t){if(t instanceof AuthenticationError)throw t;throw new AuthenticationError("Authentication failed")}};export const requireAuthStudent=t=>{if(!t.isAuthenticated||!t.student)throw new AuthenticationError("You must be logged in as a student to perform this action");return t.student};export const authStudent=async t=>{const e=t.req?.headers?.authorization,n=await getStudentAuthContext(e);return requireAuthStudent(n)};