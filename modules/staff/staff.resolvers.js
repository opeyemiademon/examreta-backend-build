import{generateAccessToken,generateRandomNo}from"../../globalFunction.js";import Staff from"./staff.model.js";import bcrypt from"bcrypt";import LoginReport from"../loginreport/loginreport.model.js";import School from"../school/school.model.js";import{requireAuth}from"../../middleware/auth.js";const staffResolvers={Query:{staffs:async()=>{try{return await Staff.find({is_deleted:!1}).sort({createdAt:-1})}catch(e){return{status:400,type:"error",message:e.message}}},getStaffById:async(e,s,t)=>{try{const e=requireAuth(t),s=await Staff.findById(e?.id);return s||{status:400,type:"error",message:`Staff with ID ${e?.id} not found`}}catch(e){return{status:400,type:"error",message:e.message}}},getSchoolStaff:async(e,s,t)=>{const a=requireAuth(t),r=Array.isArray(a?.school)?a.school[0]:a?.school,o=r?.id||r?._id||r||null;if(!o)return{school:[],staff:[]};const[n,f]=await Promise.all([School.findById(o),Staff.find({school:o,is_deleted:!1}).sort({fullname:1})]);return{school:n?[n]:[],staff:f}},getStaffAndSchoolForRegistration:async(e,s)=>{try{const[e,t]=await Promise.all([School.findById(s.schoolId),Staff.findById(s.staffId)]);return e?t?{status:200,type:"success",message:"Staff and school found",school_name:e.name,staff_name:t.fullname}:{status:404,type:"error",message:"Staff not found",school_name:e.name,staff_name:""}:{status:404,type:"error",message:"School not found",school_name:"",staff_name:""}}catch(e){return{status:400,type:"error",message:e.message,school_name:"",staff_name:""}}}},Mutation:{staffLogin:async(e,s,t)=>{const a=await Staff.findOne({email_address:s.email_address,is_email_verify:!0,status:"Active"});if(a){let e=a;var r=bcrypt.compareSync(s.password,e.password);let t=generateRandomNo(10);if(r){var o=generateAccessToken(e.id);let s={user:e.id,ip:"",device:"",usertype:"Staff",location:"",session_id:t,status:"Success",timeStart:Date.now()};const a=new LoginReport(s);return await a.save(),{message:"You have successfully login",type:"success",token:o,status:200,staff_id:e.id,session_id:t,expires_in:"3h"}}{let s={user:e.id,ip:"",device:"",usertype:"Staff",location:"",status:"Failed",session_id:t,timeStart:Date.now()};const a=new LoginReport(s);return await a.save(),{status:404,type:"error",message:"it looks like these are not your correct details"}}}return{status:200,type:"success",message:"User not found"}},staffLoginAsAdmin:async(e,s,t)=>{try{requireAuth(t);const{staffId:e}=s;if(!e)return{status:400,type:"error",message:"Staff ID is required"};const a=await Staff.findById(e);if(!a)return{status:404,type:"error",message:"Staff not found"};if("Active"!==a.status)return{status:400,type:"error",message:"Staff account is not active"};const r=generateRandomNo(10),o=generateAccessToken(a.id),n={user:a.id,ip:"",device:"",usertype:"Staff",location:"",session_id:r,status:"Success",timeStart:Date.now()},f=new LoginReport(n);return await f.save(),{message:`You have successfully logged in as ${a.fullname}`,type:"success",token:o,status:200,staff_id:a.id,session_id:r,expires_in:"3h"}}catch(e){return{status:400,type:"error",message:e.message}}},deleteStaff:async(e,s)=>{try{return await Staff.findByIdAndDelete(s.id)?{status:200,type:"success",message:"Staff successfully deleted"}:{status:400,type:"error",message:`Staff with ID ${s.id} not found`}}catch(e){return{status:400,type:"error",message:e.message}}},addStaff:async(e,s)=>{try{const e=bcrypt.hashSync(s.data.password,10);s.data.password=e,s.data.is_email_verify=!0,s.data.status="Active",s.data.role="Admin",s.data.allow_newsletter=!0,s.data.allow_email_notification=!1;const t=new School({name:s.data.school,address:s.data.address,website:s.data.website,status:"Active"}),a=await t.save();s.data.school=a.id;const r=new Staff(s.data);return await r.save(),{status:200,type:"success",message:"Staff account successfully created"}}catch(e){return{status:400,type:"error",message:e.message}}},updateStaff:async(e,s)=>{try{const e=await Staff.findById(s.id);if(!e)return{status:400,type:"error",message:`Staff with ID ${s.id} not found`};const t={...s.data};if(void 0!==t.first_name||void 0!==t.last_name||void 0!==t.fullname){const s=t.first_name??e.first_name??"",a=`${s} ${t.last_name??e.last_name??""}`.trim();t.fullname=t.fullname??a}return await Staff.findByIdAndUpdate(s.id,t,{new:!0})?{status:200,type:"success",message:"Staff successfully updated"}:{status:400,type:"error",message:`Staff with ID ${s.id} not found`}}catch(e){return{status:400,type:"error",message:e.message}}},updateStaffName:async(e,s,t)=>{try{const e=requireAuth(t);return await Staff.findByIdAndUpdate(e?.id,{fullname:s.data.fullname},{new:!0})?{status:200,type:"success",message:"Name updated successfully"}:{status:400,type:"error",message:"Unable to update staff name"}}catch(e){return{status:400,type:"error",message:e.message}}},updateStaffEmail:async(e,s,t)=>{try{const e=requireAuth(t),a=await Staff.findById(e?.id);if(!a)return{status:400,type:"error",message:"Staff not found"};if(await Staff.findOne({email_address:s.data.email_address,_id:{$ne:e?.id}}))return{status:400,type:"error",message:"Email address already in use"};return!!a.password&&bcrypt.compareSync(s.data.current_password,a.password)?(a.email_address=s.data.email_address,await a.save(),{status:200,type:"success",message:"Email updated successfully"}):{status:400,type:"error",message:"Current password is incorrect"}}catch(e){return{status:400,type:"error",message:e.message}}},updateStaffPassword:async(e,s,t)=>{try{const e=requireAuth(t),a=await Staff.findById(e?.id);if(!a)return{status:400,type:"error",message:"Staff not found"};if(!(!!a.password&&bcrypt.compareSync(s.data.current_password,a.password)))return{status:400,type:"error",message:"Current password is incorrect"};const r=bcrypt.hashSync(s.data.new_password,10);return a.password=r,await a.save(),{status:200,type:"success",message:"Password updated successfully"}}catch(e){return{status:400,type:"error",message:e.message}}},registerStaff:async(e,s)=>{try{const{schoolId:e,staffId:t,fullname:a,email_address:r,password:o,telephone:n}=s.data;if(!await School.findById(e))return{status:404,type:"error",message:"School not found"};if(await Staff.findOne({email_address:r,_id:{$ne:t}}))return{status:400,type:"error",message:"Email address is already in use"};const f=bcrypt.hashSync(o,10),i=new Staff({fullname:a,email_address:r,password:f,telephone:n,is_email_verify:!0,status:"Active",role:"Staff",school:[e]});return await i.save(),{status:200,type:"success",message:"Staff account successfully created"}}catch(e){return{status:400,type:"error",message:e.message}}}}};export default staffResolvers;