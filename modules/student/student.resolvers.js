import Student from"./student.model.js";import Exam from"../exam/exam.model.js";import Question from"../question/question.model.js";import mongoose from"mongoose";import{authStudent,requireAuth}from"../../middleware/auth.js";import{generateAccessToken,getAbsoluteUrl,getDevice,getIp,getLocation}from"../../globalFunction.js";import{processBase64Upload,ALLOWED_IMAGE_TYPES}from"../../utils/fileUpload.js";import{renderHtml}from"../../utils/pdfRender.js";import ExcelJS from"exceljs";async function performAutoMarking(e,t){const s=(e,t=!1)=>{if("boolean"==typeof e)return e;if("string"==typeof e){const t=e.trim().toLowerCase();return["true","1","yes","y","on"].includes(t)}return"number"==typeof e?0!==e:t},a=(e,t)=>{let a=String(e||"").trim();const n=s(t?.strictPunctuation,!1),r=s(t?.ignoreSpaces,!1),o=s(t?.caseSensitive,!1);return n||(a=a.replace(/[.,/#!$%^&*;:{}=\-_`~()\[\]"'<>?@+|\\]/g,"")),r&&(a=a.replace(/\s+/g,"")),o||(a=a.toLowerCase()),a},n=e.settings||{},r=e.markingRules||{};if(!s(n.enableAutoMarking,!0))return{isCorrect:null,pointsAwarded:0};const o=e.points||e.totalPoints||0,i=(r.awardPointsBy||"all_correct").toLowerCase();if("simple_answer"===e.type){if(!t||!t.trim())return{isCorrect:null,pointsAwarded:0};const s=Array.isArray(e.answers)?e.answers:e.answers?[e.answers]:e.correctAnswer?[e.correctAnswer]:[];if(0===s.length)return{isCorrect:null,pointsAwarded:0};const r=a(t,n),i=s.some(e=>a(String(e),n)===r);return{isCorrect:i,pointsAwarded:i?o:0}}if("multiple_choice"===e.type){const s="multiple"===e.selectionMode?JSON.parse(t||"[]"):[t].filter(Boolean),a=(e.answerOptions||[]).filter(e=>e.isCorrect||e.is_correct||e.correct).map(e=>String(e.id||e.content||""));if(0===a.length)return{isCorrect:null,pointsAwarded:0};let n;if("multiple"===e.selectionMode){const e=new Set(s.map(String)),t=new Set(a);n=e.size===t.size&&[...e].every(e=>t.has(e))}else n=s[0]===a[0];if("multiple"===e.selectionMode&&"per_answer"===i){const e=r.pointsPerAnswer||o/a.length,t=s.filter(e=>a.includes(e)).length;return s.some(e=>!a.includes(e))?{isCorrect:!1,pointsAwarded:0}:{isCorrect:n,pointsAwarded:t*e}}return{isCorrect:n,pointsAwarded:n?o:0}}if("match_answers"===e.type){const s=JSON.parse(t||"{}"),a=e.matchPairs||[],n={};a.forEach(e=>{e.id&&(n[String(e.id)]=String(e.match||""))});const u=Object.keys(n),d=u.filter(e=>s[e]).filter(e=>s[e]===n[e]).length,c=u.length>0&&d===u.length;if("per_answer"===i){return{isCorrect:c,pointsAwarded:d*(r.pointsPerMatch||r.pointsPerAnswer||o/u.length)}}return{isCorrect:c,pointsAwarded:c?o:0}}if("fill_gaps"===e.type){const s=JSON.parse(t||"{}"),u=e.gaps||[];let d=0,c=0;u.forEach(e=>{const t=String(e.id||""),r=(s[t]||"").trim();r&&d++;const o=e.acceptedAnswers||[];if(o.length>0){const e=a(r,n);o.some(t=>a(t,n)===e)&&c++}});const m=u.length>0&&c===u.length;if("per_answer"===i){const e=r.pointsPerGap||o/u.length;return{isCorrect:m,pointsAwarded:c*e}}return{isCorrect:m,pointsAwarded:m?o:0}}if("grid"===e.type){const s=JSON.parse(t||"{}"),u=e.rows||[],d=e.columns||[];let c=0;u.forEach(e=>{const t=String(e.id||""),r=s[t]||{},o=e.cells||[];let i=!0,u=!1;d.forEach((e,t)=>{const s=String(e.id||""),d=(r[s]||"").trim(),c=o[t]?.value;if(d&&(u=!0),void 0!==c){a(d,n)!==a(String(c),n)&&(i=!1)}}),u&&i&&c++});const m=u.length>0&&c===u.length;if("per_answer"===i){const e=r.pointsPerRow||o/u.length;return{isCorrect:m,pointsAwarded:c*e}}return{isCorrect:m,pointsAwarded:m?o:0}}return{isCorrect:null,pointsAwarded:0}}function finalizeStudentExamSession(e,t){const s=Array.isArray(e.examSessions)&&e.examSessions.length>0?e.examSessions[e.examSessions.length-1]:null;if(!s)return{success:!1,reason:"Session not found"};if("submitted"===s.status)return{success:!1,reason:"Exam already submitted"};s.status="submitted";const a=new Date;s.endTime=a,s.submittedAt=a,s.securityEvents.push({eventType:"exam",timestamp:new Date,details:"Exam submitted"}),t?.answerContent&&(s.answerContent=t.answerContent),s.startTime&&(s.timeElapsed=Math.floor((s.endTime.getTime()-s.startTime.getTime())/1e3));let n=0,r=0;return Array.isArray(s.answers)&&s.answers.forEach(e=>{null!=e?.isCorrect&&(n+=e.pointsAwarded||0),r+=e?.maxPoints||0}),s.totalScore=n,s.maxScore=r,s.percentageScore=r>0?n/r*100:0,e.currentSessionId=null,{success:!0}}async function writeStudentSessionToDoc(e,t,s,a){const n=t.exam,r=t.school,o=Array.isArray(s?.answers)?s.answers:[];if(e.fontSize(16).text(`${r?.name||""}`),e.fontSize(14).text(`${n?.name||""}`),e.moveDown(),a?e.fontSize(16).text(`${t.studentNumber} - ${t.firstName} ${t.lastName}`):e.fontSize(16).text(`${t.studentNumber}`),t.teacherName&&(e.fontSize(14).text(`Teacher: ${t.teacherName||""} ${t.class||""}`),e.moveDown()),"auto_marked"===n?.examFormat&&"submitted"===s.status&&e.fontSize(12).text(`Total Score: ${s.totalScore||0}, Max Score: ${s.maxScore||0}, Percentage: ${s.percentageScore?s.percentageScore.toFixed(2)+"%":"0%"}`),e.fontSize(12).text(`Start Time: ${s.startTime?new Date(s.startTime).toLocaleString():""}, End Time: ${s.endTime?new Date(s.endTime).toLocaleString():""}`),e.moveDown(),e.moveTo(50,e.y).lineTo(550,e.y).stroke(),e.moveDown(),"auto_marked"===n?.examFormat){const u={};for(const f of o)f?.questionId&&(u[String(f.questionId)]=f);const d=Object.keys(u),c=await Question.find({_id:{$in:d}}).exec(),m={};for(const y of c)m[String(y._id)]=y;const l=Array.isArray(n?.sections)?n.sections:[],p=new Set;async function i(t,s,a){e.fontSize(12);const n=(s?.questionText||"").replace(/<[^>]*>/g,"");e.text(`Question ${t}: `,{continued:!0}),e.text(` ${n}`);let r="";if("grid"===s.questionType)try{const e=JSON.parse(s.answer);r="object"==typeof e&&null!==e?Object.values(e).map(e=>"object"==typeof e&&null!==e?Object.values(e).map(e=>e).join(", "):e).join(", "):s.answer}catch{r=s.answer}else if("fill_gaps"===s.questionType)try{const e=JSON.parse(s.answer);r="object"==typeof e&&null!==e?Object.entries(e).map(([e,t])=>`${t}`).join(", "):s.answer}catch{r=s.answer}else if("match_answers"===s.questionType)try{const e=JSON.parse(s.answer),t=JSON.parse(s.questionCorrectAnswer||"{}");r="object"==typeof e&&null!==e?Object.entries(e).map(([e,a])=>{t[e];const n=s.questionOptions?.find(e=>e.id===a),r=n&&n.match||e;return` ${n&&(n.option||n.text)||a} ->  ${r} `}).join(", "):s.answer}catch{r=s.answer}else if("free_text"===s.questionType)renderHtml(e,s.answer.replace(/<[^>]*>/g,""));else if("attachment"===s.questionType)if(s.attachments&&Array.isArray(s.attachments)){e.text("Answer: Attachments");for(const t of s.attachments){const s=t.fileName||t.name||"Attachment",a=t.fileUrl||t.url||t;if(e.moveDown(.5),e.fontSize(10).text(`File: ${s}`,{link:a}),"string"==typeof a&&a.startsWith("http"))try{if(/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(a)){const t=await import("https"),s=await import("http"),n=a.startsWith("https")?t:s,r=await new Promise((e,t)=>{n.default.get(a,s=>{const a=[];s.on("data",e=>a.push(e)),s.on("end",()=>e(Buffer.concat(a))),s.on("error",t)}).on("error",t)}),o=400,i=300;e.image(r,{fit:[o,i],align:"left"}),e.moveDown()}}catch(t){e.fontSize(10).fillColor("red").text("(Image could not be loaded)"),e.fillColor("black")}}r=""}else r="No attachments found";else if("multiple_choice"===s.questionType){const e=m[String(s.questionId)]||await Question.findById(s.questionId).exec();let t;try{t=JSON.parse(s.answer)||[]}catch{t=s.answer}r=(Array.isArray(t)?t:[t]).map(t=>{const s=e?.answerOptions?.find(e=>e.id===t);return s?s?.content?.replace(/<[^>]*>/g,""):JSON.stringify(t)}).join(", ")}else if("match_answers"===s.questionType){const e=m[String(s.questionId)]||await Question.findById(s.questionId).exec();let t;try{t=JSON.parse(s.answer)||{};r=Object.entries(t).map(([t,s])=>{const a=e?.matchPairs?.find(e=>e.id===t),n=e?.matchPairs?.find(e=>e.id===s);return`${a?.option?.replace(/<[^>]*>/g,"")||t} â†’ ${n?.match?.replace(/<[^>]*>/g,"")||s}`}).join(", ")}catch{t=s.answer,r=t}}else{let e;try{e=JSON.parse(s.answer)||[]}catch{e=s.answer}r=(Array.isArray(e)?e:[e]).map(e=>{const t=s.questionOptions?.find(t=>t.id===e);return t?JSON.stringify(t.match)||t.content.replace(/<[^>]*>/g,""):JSON.stringify(e)}).join(", ")}r&&e.text(`Answer: ${r}`),e.moveDown(),e.fontSize(12).text(`Points: ${s.pointsAwarded||0}/${s.maxPoints||0}`),e.moveDown()}for(const h of l){const w=Array.isArray(h?.questionIds)?h.questionIds:[];if(!w.length)continue;e.fontSize(13).text(String(h.title||""),{underline:!0}),e.moveDown(.5);let S=0;for(const x of w){const A=m[String(x)],b=u[String(x)];if(!b||p.has(String(x)))continue;if(A&&A.mainQuestionId)continue;S+=1;const N=String(S);await i(N,b),p.add(String(x));const I=c.filter(e=>String(e.mainQuestionId||"")===String(x));let v=0;for(const E of I){const _=u[String(E._id)];if(!_||p.has(String(E._id)))continue;const q=String.fromCharCode("b".charCodeAt(0)+v);v+=1,await i(q,_),p.add(String(E._id))}}}const g=c.filter(e=>!p.has(String(e._id)));if(g.length){e.fontSize(13).text("Additional Questions",{underline:!0}),e.moveDown(.5);let T=0;for(const C of g){if(C.mainQuestionId)continue;const k=u[String(C._id)];if(!k)continue;T+=1;const D=String(T);await i(D,k),p.add(String(C._id));const $=g.filter(e=>String(e.mainQuestionId||"")===String(C._id));let O=0;for(const P of $){const R=u[String(P._id)];if(!R||p.has(String(P._id)))continue;const z=String.fromCharCode("b".charCodeAt(0)+O);O+=1,await i(z,R),p.add(String(P._id))}}}}else e.fontSize(12).text("Answer:"),renderHtml(e,s?.answerContent||"No answer provided"),e.moveDown();e.moveTo(50,e.y).lineTo(550,e.y).stroke(),e.fontSize(12).text("Powered By: Examreta.com")}function writeStudentSummaryToDoc(e,t,s,a){const n=a?.schoolName??a?.schoolName??"",r=a?.examName??a?.examName??"";e.fontSize(18).text(n||"School",{align:"center"}),e.fontSize(16).text(r||"Exam",{align:"center"}),e.moveDown();const o=e.page.width-e.page.margins.left-e.page.margins.right,i=e.page.margins.left,u=["Student Number","First Name","Last Name","Class","Total Score","Max Score","Percentage Score"],d=[t.studentNumber||"N/A",t.firstName||"N/A",t.lastName||"N/A",t.class||"N/A",(s?.totalScore??0).toString(),(s?.maxScore??0).toString(),"number"==typeof s?.percentageScore?`${s.percentageScore.toFixed(2)}%`:"N/A"];e.fontSize(12);const c=e.y;e.rect(i,c,o,22).stroke(),u.forEach((t,s)=>{const a=o/u.length,n=i+s*a;e.text(t,n+5,c+5,{width:a-10,align:"left"})});const m=c+22;e.rect(i,m,o,22).stroke(),d.forEach((t,s)=>{const a=o/d.length,n=i+s*a;e.text(t,n+5,m+5,{width:a-10,align:"left"})}),e.y=m+22+10,e.moveDown()}function writeStudentExamKeyToDoc(e,t,s){const a=s?.schoolName??s?.schoolName??"",n=s?.examName??s?.examName??"";e.fontSize(18).text(a||"School"),e.fontSize(16).text(n||"Exam"),e.moveDown();const r=e.page.width-e.page.margins.left-e.page.margins.right,o=e.page.margins.left,i=["Student Number","First Name","Last Name","Resume Key"],u=[t.studentNumber||"N/A",t.firstName||"N/A",t.lastName||"N/A",t.resumeKey||"N/A"];e.fontSize(12);const d=e.y;e.rect(o,d,r,22).stroke(),i.forEach((t,s)=>{const a=r/i.length,n=o+s*a;e.text(t,n+5,d+5,{width:a-10,align:"left"})});const c=d+22;e.rect(o,c,r,22).stroke(),u.forEach((t,s)=>{const a=r/u.length,n=o+s*a;e.text(t,n+5,c+5,{width:a-10,align:"left"})}),e.y=c+22+10,e.moveDown()}const studentResolvers={Query:{students:async(e,t,s)=>{try{const e=requireAuth(s),t=e?.school[0].id;return await Student.find({is_deleted:!1,school:t}).populate("exam").populate("school").sort({createdAt:-1})}catch(e){return{status:400,type:"error",message:e.message}}},getStudentById:async(e,t)=>{try{const e=await Student.findOne({_id:t.id,is_deleted:!1}).populate("school");return e||{status:400,type:"error",message:`Student with ID ${t.id} not found`}}catch(e){return{status:400,type:"error",message:e.message}}},getStudentsByExam:async(e,t,s)=>{try{const e=requireAuth(s);e?.school[0].id;return await Student.find({exam:t.examId,is_deleted:!1}).sort({createdAt:-1})}catch(e){return{status:400,type:"error",message:e.message}}},getStudentsByExamKey:async(e,t)=>{try{return await Student.find({examKey:t.examKey,is_deleted:!1}).sort({createdAt:-1})}catch(e){return{status:400,type:"error",message:e.message}}},getStudentExamResult:async(e,t,s)=>{const a=await authStudent(s);if(a&&String(a.id)!==String(t.studentId))return{status:400,type:"error",message:"Unauthorized access to exam result"};const n=await Student.findOne({_id:t.studentId,is_deleted:!1}).populate("exam");if(!n)return{status:400,type:"error",message:"Student not found"};const r=n.examSessions?.[n.examSessions.length-1];if(!r)return{status:400,type:"error",message:"Session not found"};if("submitted"!==r.status)return{status:400,type:"error",message:"exam not submitted"};const o=n.exam,i=r.answers||[],u=r.totalScore??0,d=r.maxScore??0,c=i.reduce((e,t)=>e+(t?.maxPoints||0),0),m=d||c,l=(Array.isArray(o?.questions)?o.questions.length:void 0)??(Array.isArray(r.questionOrder)?r.questionOrder.length:void 0)??i.length??0,p=i.filter(e=>!0===e?.isCorrect).length,g=i.filter(e=>!1===e?.isCorrect).length,f=p+g,y=l>f?l-f:0,h=r.percentageScore??(m?u/m*100:0),w=r.startTime?new Date(r.startTime):null,S=r.endTime?new Date(r.endTime):null,x=r.timeElapsed??(w&&S?Math.max(0,Math.floor((S.getTime()-w.getTime())/1e3)):null),A=null==h?null:h>=(o?.settings?.percentagePassValue??50)?"Pass":"Fail";return{examId:o?._id||r.examId,examTitle:o?.name||null,examFormat:o?.examFormat||null,score:u,maxScore:m,totalQuestions:l,percentage:h,correctAnswers:p,incorrectAnswers:g,unanswered:y,durationSeconds:x,submittedAt:r.submittedAt||(r.endTime?r.endTime.toISOString?.()??r.endTime:null),grade:A,settings:{percentagePass:o?.settings?.percentagePass,showResult:o?.settings?.showResult}}},getStudentAnswerPDF:async(e,t,s)=>{try{requireAuth(s);const e=await Student.findById(t.id).populate("school").populate("exam").populate({path:"examSessions",populate:{path:"answers"}}).populate({path:"exam",populate:{path:"staff"}});if(!e)throw new Error("Student not found");const a=e.examSessions[e.examSessions.length-1];if(!a)throw new Error("No session found");const n=new(0,(await import("pdfkit")).default),r=[];n.on("data",e=>r.push(e));const o=new Promise((e,t)=>{n.on("end",()=>{const t=Buffer.concat(r).toString("base64");e(`data:application/pdf;base64,${t}`)}),n.on("error",t)});let i=!0;return await writeStudentSessionToDoc(n,e,a,i),n.end(),o}catch(e){throw new Error(e.message)}},getAllStudentAnswerPDF:async(e,t,s)=>{try{requireAuth(s);const e=(await Student.find({exam:t.examId,is_deleted:!1}).populate("school").populate("exam").populate({path:"examSessions",populate:{path:"answers"}}).sort({createdAt:1})).filter(e=>Array.isArray(e.examSessions)&&e.examSessions.length>0);if(!e.length)throw new Error("No student sessions found for this exam");const a=new(0,(await import("pdfkit")).default)({autoFirstPage:!1}),n=[];a.on("data",e=>n.push(e));const r=new Promise((e,t)=>{a.on("end",()=>{const t=Buffer.concat(n).toString("base64");e(`data:application/pdf;base64,${t}`)}),a.on("error",t)});for(const s of e){const e=s.examSessions[s.examSessions.length-1];e&&(a.addPage(),await writeStudentSessionToDoc(a,s,e,t.showName))}return a.end(),r}catch(e){throw new Error(e.message)}},getAllAnswerPDF:async(e,t,s)=>{try{requireAuth(s);const e=(await Student.find({exam:t.examId,is_deleted:!1}).populate({path:"exam",select:"name"}).populate({path:"school",select:"name"}).populate({path:"examSessions",select:"totalScore maxScore percentageScore createdAt status"}).sort({createdAt:1})).filter(e=>Array.isArray(e.examSessions)&&e.examSessions.length>0);if(!e.length)throw new Error("No student sessions found for this exam");const a=new(0,(await import("pdfkit")).default)({autoFirstPage:!1}),n=[];a.on("data",e=>n.push(e));const r=new Promise((e,t)=>{a.on("end",()=>{const t=Buffer.concat(n).toString("base64");e(`data:application/pdf;base64,${t}`)}),a.on("error",t)});return e.forEach(e=>{const t=e.examSessions[e.examSessions.length-1];if(!t)return;a.addPage();writeStudentSummaryToDoc(a,e,t,{schoolName:e?.school?.name??"",examName:e?.exam?.name??""})}),a.end(),r}catch(e){throw new Error(e.message)}},getAllAnswerExcel:async(e,t,s)=>{try{requireAuth(s);const e=(await Student.find({exam:t.examId,is_deleted:!1}).populate("exam").populate("school").populate({path:"examSessions",select:"totalScore maxScore percentageScore createdAt status"}).sort({createdAt:1})).filter(e=>Array.isArray(e.examSessions)&&e.examSessions.length>0);if(!e.length)throw new Error("No student sessions found for this exam");const a=e[0],n=a?.school?.name??"School",r=a?.exam?.name??"Exam",o=new ExcelJS.Workbook,i=o.addWorksheet("Student Answers"),u=[{header:"Student Number",key:"studentNumber",width:20},{header:"First Name",key:"firstName",width:20},{header:"Last Name",key:"lastName",width:20},{header:"Class",key:"className",width:15},{header:"Total Score",key:"totalScore",width:15},{header:"Max Score",key:"maxScore",width:15},{header:"Percentage Score",key:"percentageScore",width:18}];i.columns=u;const d=u.length,c=Array(d).fill("");c[0]=n,i.spliceRows(1,0,c),i.mergeCells(1,1,1,d);const m=i.getRow(1);m.font={bold:!0,size:14},m.alignment={horizontal:"center"};const l=Array(d).fill("");l[0]=r,i.spliceRows(2,0,l),i.mergeCells(2,1,2,d);const p=i.getRow(2);p.font={bold:!0,size:12},p.alignment={horizontal:"center"};const g=i.getRow(3);g.font={bold:!0},g.alignment={horizontal:"center"},e.forEach(e=>{const t=e.examSessions[e.examSessions.length-1];t&&i.addRow({studentNumber:e.studentNumber||"",firstName:e.firstName||"",lastName:e.lastName||"",className:e.class||"",totalScore:t.totalScore??0,maxScore:t.maxScore??0,percentageScore:"number"==typeof t.percentageScore?t.percentageScore:""})}),i.eachRow((e,t)=>{if(t>2&&e.eachCell(e=>{e.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}}),t>3){const t=e.getCell("percentageScore");"number"==typeof t.value&&(t.value=t.value/100,t.numFmt="0.00%")}});const f=await o.xlsx.writeBuffer();return"data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,"+Buffer.from(f).toString("base64")}catch(e){throw new Error(e.message)}},getAllStudentExamKeyPDF:async(e,t,s)=>{try{requireAuth(s);const e=await Student.find({exam:t.examId,is_deleted:!1}).populate({path:"exam",select:"name"}).populate({path:"school",select:"name"}).sort({createdAt:1});if(!e.length)throw new Error("No students found for this exam");const a=new(0,(await import("pdfkit")).default)({autoFirstPage:!1}),n=[];a.on("data",e=>n.push(e));const r=new Promise((e,t)=>{a.on("end",()=>{const t=Buffer.concat(n).toString("base64");e(`data:application/pdf;base64,${t}`)}),a.on("error",t)});return e.forEach(e=>{a.addPage();writeStudentExamKeyToDoc(a,e,{schoolName:e?.school?.name??"",examName:e?.exam?.name??""})}),a.end(),r}catch(e){throw new Error(e.message)}},getStudentAttendanceExcel:async(e,t,s)=>{try{requireAuth(s);const e=await Student.find({exam:t.examId,is_deleted:!1}).populate({path:"exam",select:"name"}).populate({path:"school",select:"name"}).sort({createdAt:1});if(!e.length)throw new Error("No students found for this exam");const a=e[0],n=a?.school?.name??"School",r=a?.exam?.name??"Exam",o=new ExcelJS.Workbook,i=o.addWorksheet("Attendance"),u=[{header:"Student Number",key:"studentNumber",width:20},{header:"First Name",key:"firstName",width:20},{header:"Last Name",key:"lastName",width:20},{header:"Class",key:"className",width:15}];i.columns=u;const d=u.length,c=Array(d).fill("");c[0]=n,i.spliceRows(1,0,c),i.mergeCells(1,1,1,d);const m=i.getRow(1);m.font={bold:!0,size:14},m.alignment={horizontal:"center"};const l=Array(d).fill("");l[0]=r,i.spliceRows(2,0,l),i.mergeCells(2,1,2,d);const p=i.getRow(2);p.font={bold:!0,size:12},p.alignment={horizontal:"center"};const g=i.getRow(3);g.font={bold:!0},g.alignment={horizontal:"center"},e.forEach(e=>{i.addRow({studentNumber:e.studentNumber||"",firstName:e.firstName||"",lastName:e.lastName||"",className:e.class||""})}),i.eachRow((e,t)=>{t>2&&e.eachCell(e=>{e.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}})});const f=await o.xlsx.writeBuffer();return"data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,"+Buffer.from(f).toString("base64")}catch(e){throw new Error(e.message)}},getCurrentSession:async(e,t)=>{try{const e=await Student.findOne({_id:t.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};if(!e.currentSessionId)return{status:400,type:"error",message:"No active session found"};return e.examSessions.id(e.currentSessionId)}catch(e){return{status:400,type:"error",message:e.message}}}},Mutation:{registerStudent:async(e,t)=>{try{const e=await Exam.findOne({_id:t.data.examId,is_deleted:!1,school:t.data.schoolId});if(!e)return{status:400,type:"error",message:"Exam not found"};if("Open"!==e.access)return{status:400,type:"error",message:"Exam access is not Open"};if(await Student.findOne({examKey:t.data.examKey,studentNumber:t.data.studentNumber,school:t.data.schoolId,is_deleted:!1}))return{status:401,type:"error",message:"Student already registered for this exam"};const s=new Student({...t.data,currentSessionId:new mongoose.Types.ObjectId,exam:t.data.examId,school:t.data.schoolId});await s.save();const a=generateAccessToken(s.id);return{status:200,type:"success",message:"Student successfully registered",studentId:s.id,token:a}}catch(e){return{status:400,type:"error",message:e.message}}},uploadStudentsByExcel:async(e,t,s)=>{try{const e=requireAuth(s),{examId:a,schoolId:n,excelFile:r}=t.data;if(!a)return{status:400,type:"error",message:"Exam id is required"};if(!r)return{status:400,type:"error",message:"Excel file is required"};const o=await Exam.findOne({_id:a,is_deleted:!1});if(!o)return{status:400,type:"error",message:"Exam not found"};const i=n||(Array.isArray(o.school)?o.school[0]:o.school)||e?.school?.[0]?.id;if(!i)return{status:400,type:"error",message:"Unable to determine school for uploaded students"};const u=r.includes(",")?r.split(",")[1]:r,d=Buffer.from(u,"base64"),c=new ExcelJS.Workbook;await c.xlsx.load(d.buffer.slice(d.byteOffset,d.byteOffset+d.byteLength));const m=c.getWorksheet(1);if(!m)return{status:400,type:"error",message:"No worksheet found in Excel file"};const l=(e,t)=>{const s=e.getCell(t)?.value;return null==s?"":"object"==typeof s&&"text"in s&&void 0!==s.text?s.text.toString().trim():"object"==typeof s&&"richText"in s&&Array.isArray(s.richText)?s.richText.map(e=>e?.text||"").join("").trim():s.toString().trim()},p=[],g=new Set,f=[];if(m.eachRow((e,t)=>{if(1===t)return;const s=l(e,1).toUpperCase();s&&(g.has(s)?f.push(s):(g.add(s),p.push({studentNumber:s,firstName:l(e,2)||"",lastName:l(e,3)||"",email:l(e,4)||"",class:l(e,5)||"",telephone:l(e,6)||"",teacherName:l(e,7)||""})))}),!p.length)return{status:400,type:"error",message:"No students found in the uploaded file"};const y=await Student.find({exam:o._id,studentNumber:{$in:p.map(e=>e.studentNumber)},school:i,is_deleted:!1}).select("studentNumber"),h=new Set(y.map(e=>(e.studentNumber||"").toUpperCase())),w=p.filter(e=>!h.has(e.studentNumber)).map(e=>({examKey:o.examKey,exam:o._id,school:i,studentNumber:e.studentNumber,firstName:e.firstName,lastName:e.lastName,email:e.email,class:e.class,telephone:e.telephone,teacherName:e.teacherName,resumeKey:Math.random().toString(36).substring(2,8)}));if(!w.length)return{status:400,type:"error",message:"All students in the file already exist for this exam"};await Student.insertMany(w,{ordered:!1});let S=`${w.length} students imported successfully.`;return h.size&&(S+=` ${h.size} existing student(s) were skipped.`),f.length&&(S+=` ${f.length} duplicate student number(s) in the file were ignored.`),{status:200,type:"success",message:S}}catch(e){return{status:400,type:"error",message:e.message}}},verifyResumeKey:async(e,t)=>{try{const e=await Student.findOne({resumeKey:t.resumeKey,is_deleted:!1}).populate("exam");if(!e)return{status:400,type:"error",message:"Student not found"};if("Active"!==e.exam.status)return{status:400,type:"error",message:"Exam is not active"};const s=e.examSessions[e.examSessions.length-1];if(!s)return{status:400,type:"error",message:"No active session found"};if("in_progress"!==s.status)return{status:400,type:"error",message:"Exam is not in progress"};s.securityEvents.push({eventType:"exam",timestamp:new Date,details:"Resume key verified"}),await e.save();const a=generateAccessToken(e?.id);return{status:200,type:"success",message:"Student successfully login",studentId:e?.id,examId:e?.exam?._id,examKey:e?.exam?.examKey,token:a}}catch(e){return{status:400,type:"error",message:e.message}}},startExamSession:async(e,t,s)=>{try{await authStudent(s);const e=await Student.findOne({_id:t.data.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};if(e.isBlocked)return{status:400,type:"error",message:`Student is blocked: ${e.blockReason}`};const a=await Exam.findById(t.data.examId);if(!a)return{status:400,type:"error",message:"Exam not found"};const n=Math.random().toString(36).substring(2,8);let r=getIp(s.req),o=getDevice(s.req).userAgent,i=getLocation(r);const u={examId:t.data.examId,status:"in_progress",startTime:new Date,ipAddress:r,userAgent:i,examSettings:a.settings,questionOrder:t.data.questionOrder,timeLimit:a.settings?.timeLimitMinutes,timeRemaining:a.settings?.timeLimitMinutes?60*a.settings.timeLimitMinutes:null,accessGranted:!0,attemptNumber:e.examSessions.length+1,ipAddresses:[{ip:r,timestamp:new Date,location:o}],securityEvents:[{eventType:"exam",timestamp:new Date,details:"Exam started"}]};return e.resumeKey=n,e.examSessions.push(u),e.currentSessionId=e.examSessions[e.examSessions.length-1]._id,await e.save(),e}catch(e){return{status:400,type:"error",message:e.message}}},submitAnswer:async(e,t,s)=>{try{await authStudent(s);const e=await Student.findOne({_id:t.data.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};const a=e.examSessions[e.examSessions.length-1];if(!a){const t=await Exam.findById(e?.exam),s=Math.random().toString(36).substring(2,8);let a="",n="",r="";const o={examId:e?.exam,status:"in_progress",startTime:new Date,ipAddress:a,userAgent:n,examSettings:t?.settings,questionOrder:[],timeLimit:t?.settings?.timeLimitMinutes,timeRemaining:t?.settings?.timeLimitMinutes?60*t?.settings.timeLimitMinutes:null,accessGranted:!0,attemptNumber:e.examSessions.length+1,ipAddresses:[{ip:a,timestamp:new Date,location:r}],securityEvents:[{eventType:"exam",timestamp:new Date,details:"Exam started"}]};return e.resumeKey=s,e.examSessions.push(o),e.currentSessionId=e.examSessions[e.examSessions.length-1]._id,await e.save(),{status:200,type:"success",message:"Session created successfully"}}if("auto_marked"===t.data.examFormat){const e=await Question.findById(t.data.questionId);if(!e)return{status:400,type:"error",message:"Question not found"};let n=[];if("attachment"===e.type&&t.data.attachments&&Array.isArray(t.data.attachments)){for(const e of t.data.attachments)if(e.base64)try{const a=await processBase64Upload(e.base64,"attachments",ALLOWED_IMAGE_TYPES,`student-${t.data.studentId}`),r=getAbsoluteUrl(s.req,`/images/attachments/${a}`);n.push(r)}catch(e){console.error("Failed to upload attachment:",e.message)}t.data.attachments=t.data.attachments.map(e=>{const{base64:t,preview:s,url:a,...n}=e;return n})}const r=await performAutoMarking(e,t.data.answer),o=a.answers.find(e=>String(e?.questionId)===String(t.data.questionId));o?(o.answer=t.data.answer,o.timeSpent=t.data.timeSpent||o.timeSpent,n.length>0&&(o.attachments=[...o.attachments||[],...n]),o.isCorrect=r.isCorrect,o.pointsAwarded=r.pointsAwarded,o.attemptCount=(o.attemptCount||1)+1,o.answeredAt=new Date):a.answers.push({questionId:t.data.questionId,questionType:e.type,questionText:e.question,questionPoints:e.points||e.totalPoints||0,questionInstruction:t.data.questionInstruction,questionAttachments:[],answer:t.data.answer,maxPoints:e.points||e.totalPoints||0,timeSpent:t.data.timeSpent||0,attachments:n.length>0?n:t.data.attachments||[],isCorrect:r.isCorrect,pointsAwarded:r.pointsAwarded,answeredAt:new Date})}else a.answerContent=t.data.answerContent;return a.securityEvents.push({eventType:"exam",timestamp:new Date,details:"Answer submitted"}),a.timeRemaining=t.data.timeRemaining,await e.save(),{status:200,type:"success",message:"Answer submitted successfully"}}catch(e){return{status:400,type:"error",message:e.message}}},updateAnswer:async(e,t,s)=>{try{await authStudent(s);const e=await Student.findOne({_id:t.data.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};const a=e.examSessions[e.examSessions.length-1];if(!a)return{status:400,type:"error",message:"Session not found"};const n=a.answers.find(e=>String(e?.questionId)===String(t.data.answerId));if(!n)return{status:400,type:"error",message:"Answer not found"};const r=await Question.findById(t.data.answerId);if(!r)return{status:400,type:"error",message:"Question not found"};let o=[];if("attachment"===r.type&&t.data.attachments&&Array.isArray(t.data.attachments)){for(const e of t.data.attachments)if(e.base64)try{const a=await processBase64Upload(e.base64,"attachments",ALLOWED_IMAGE_TYPES,`student-${t.data.studentId}`),n=getAbsoluteUrl(s.req,`/images/attachments/${a}`);o.push(n)}catch(e){console.error("Failed to upload attachment:",e.message)}t.data.attachments=t.data.attachments.map(e=>{const{base64:t,preview:s,url:a,...n}=e;return n})}const i=await performAutoMarking(r,t.data.answer);return void 0!==t.data.answer&&(n.answer=t.data.answer),void 0!==t.data.timeSpent&&(n.timeSpent=t.data.timeSpent),o.length>0&&(n.attachments=[...n.attachments||[],...o]),n.isCorrect=i.isCorrect,n.pointsAwarded=i.pointsAwarded,n.attemptCount=(n.attemptCount||1)+1,n.answeredAt=new Date,a.timeRemaining=t.data.timeRemaining,a.securityEvents.push({eventType:"exam",timestamp:new Date,details:"Answer updated"}),await e.save(),{status:200,type:"success",message:"Answer updated successfully"}}catch(e){return{status:400,type:"error",message:e.message}}},bulkSubmitAnswers:async(e,t,s)=>{try{const{studentId:e,sessionId:s,answers:a,examFormat:n,timeRemaining:r}=t.data,o=await Student.findOne({_id:e,is_deleted:!1});if(!o)return{status:400,type:"error",message:"Student not found",successCount:0,failureCount:0};const i=o.examSessions[o.examSessions.length-1];if(!i)return{status:400,type:"error",message:"Session not found",successCount:0,failureCount:0};let u=0,d=0;const c=[];for(const e of a)try{const{questionId:t,answer:s,timeSpent:a,attachments:n,isUpdate:r}=e,o=await Question.findOne({_id:t,is_deleted:!1});if(!o){c.push(`Question ${t} not found`),d++;continue}if(r){const e=i.answers.find(e=>String(e?.questionId)===String(t));if(!e){c.push(`Answer for question ${t} not found for update`),d++;continue}const n=await performAutoMarking(o,s);e.answer=s,void 0!==a&&(e.timeSpent=a),e.isCorrect=n.isCorrect,e.pointsAwarded=n.pointsAwarded,e.attemptCount=(e.attemptCount||1)+1,e.answeredAt=new Date,u++}else{const e=i.answers.find(e=>String(e?.questionId)===String(t)),r=await performAutoMarking(o,s);e?(e.answer=s,void 0!==a&&(e.timeSpent=a),n&&n.length>0&&(e.attachments=[...e.attachments||[],...n]),e.isCorrect=r.isCorrect,e.pointsAwarded=r.pointsAwarded,e.attemptCount=(e.attemptCount||1)+1,e.answeredAt=new Date):i.answers.push({questionId:t,questionType:o.type,questionText:o.question,questionOptions:o.answerOptions||o.matchPairs||o.gaps,questionCorrectAnswer:o.answers?.[0]||null,questionPoints:o.points,questionInstruction:o.tip,questionAttachments:[],answer:s,timeSpent:a||0,attachments:n||[],isCorrect:r.isCorrect,pointsAwarded:r.pointsAwarded,maxPoints:o.points,attemptCount:1,answeredAt:new Date}),u++}}catch(t){c.push(`Error processing question ${e.questionId}: ${t.message}`),d++}i.timeRemaining=r,await o.save();return{status:200,type:"success",message:c.length>0?`Processed ${u} answer(s) successfully, ${d} failed. Errors: ${c.join("; ")}`:`Successfully processed ${u} answer(s)`,successCount:u,failureCount:d}}catch(e){return{status:400,type:"error",message:e.message,successCount:0,failureCount:0}}},updateSessionProgress:async(e,t)=>{try{const e=await Student.findOne({_id:t.data.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};const s=e.examSessions.id(t.data.sessionId);return s?(void 0!==t.data.currentQuestionIndex&&(s.currentQuestionIndex=t.data.currentQuestionIndex),void 0!==t.data.questionsAttempted&&(s.questionsAttempted=t.data.questionsAttempted),void 0!==t.data.questionsSkipped&&(s.questionsSkipped=t.data.questionsSkipped),void 0!==t.data.progressPercentage&&(s.progressPercentage=t.data.progressPercentage),void 0!==t.data.timeElapsed&&(s.timeElapsed=t.data.timeElapsed),void 0!==t.data.timeRemaining&&(s.timeRemaining=t.data.timeRemaining),await e.save(),{status:200,type:"success",message:"Session progress updated"}):{status:400,type:"error",message:"Session not found"}}catch(e){return{status:400,type:"error",message:e.message}}},recordSecurityEvent:async(e,t)=>{try{const e=await Student.findOne({_id:t.data.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};const s=e.examSessions[e.examSessions.length-1];return s?(s.securityEvents.push({eventType:t.data.eventType,timestamp:new Date,details:t.data.details}),"tab_switch"===t.data.eventType&&s.tabSwitchCount++,"fullscreen_exit"===t.data.eventType&&s.fullscreenExitCount++,s.suspiciousActivityCount++,await e.save(),{status:200,type:"success",message:"Security event recorded"}):{status:400,type:"error",message:"Session not found"}}catch(e){return{status:400,type:"error",message:e.message}}},submitExam:async(e,t)=>{try{const e=await Student.findOne({_id:t.data.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};const s=finalizeStudentExamSession(e,{answerContent:t.data.answerContent});return s.success?(await e.save(),{status:200,type:"success",message:"Exam submitted successfully"}):{status:400,type:"error",message:s.reason||"Unable to submit exam"}}catch(e){return{status:400,type:"error",message:e.message}}},submitExamForAll:async(e,t,s)=>{try{requireAuth(s);const{examId:e,studentId:a}=t.data,n={exam:e,is_deleted:!1};a&&(n._id=a);const r=await Student.find(n);if(!r.length)return{status:400,type:"error",message:a?"Student not found for this exam":"No students found for this exam"};let o=0,i=0,u=0;for(const e of r){const t=finalizeStudentExamSession(e);t.success?(await e.save(),o++):"Exam already submitted"===t.reason?i++:"Session not found"===t.reason&&u++}const d=a?"student":"students",c=[];return c.push(`${o} ${d}${1===o?"":"s"} submitted`),i&&c.push(`${i} already submitted`),u&&c.push(`${u} without session`),{status:200,type:"success",message:c.join(", ")}}catch(e){return{status:400,type:"error",message:e.message}}},regradeExamScores:async(e,t,s)=>{try{requireAuth(s);const{examId:e,studentId:a}=t.data||{};if(!e)return{status:400,type:"error",message:"Exam id is required"};const n={exam:e,is_deleted:!1};a&&(n._id=a);const r=await Student.find(n);if(!r.length)return{status:400,type:"error",message:a?"Student not found for this exam":"No students found for this exam"};let o=0,i=0;for(const t of r){const s=Array.isArray(t.examSessions)?t.examSessions:[];if(!s.length){i+=1;continue}let a=s[s.length-1];if(a&&a.examId&&String(a.examId)!==String(e)){const t=[...s].reverse().find(t=>String(t?.examId)===String(e));t&&(a=t)}if(!a){i+=1;continue}const n=Array.isArray(a.answers)?a.answers:[];let r=0,u=0;for(const e of n){const t=Number(e?.pointsAwarded??0),s=e?.maxPoints??e?.questionPoints??0;r+=Number.isNaN(t)?0:t;const a=Number(s??0);u+=Number.isNaN(a)?0:a}a.totalScore=Number(r.toFixed(2)),a.maxScore=Number(u.toFixed(2)),a.percentageScore=a.maxScore>0?Number((a.totalScore/a.maxScore*100).toFixed(2)):0,Array.isArray(a.securityEvents)&&a.securityEvents.push({eventType:"scores",timestamp:new Date,details:"Scores regraded"}),t.markModified("examSessions"),await t.save(),o+=1}if(!o){return{status:200,type:"info",message:`No ${a?"student":"students"} regraded. ${i} without session data.`}}const u=[`${o} ${a?"student":"students"} regraded`];return i&&u.push(`${i} without session data`),{status:200,type:"success",message:u.join(", ")}}catch(e){return{status:400,type:"error",message:e.message}}},updateExamSessionsTimeRemaining:async(e,t,s)=>{try{requireAuth(s);const{examId:e,timeInMinutes:a,studentId:n}=t.data;if(a<0)return{status:400,type:"error",message:"Time in minutes must be zero or greater"};const r={exam:e,is_deleted:!1};n&&(r._id=n);const o=await Student.find(r);if(!o.length)return{status:400,type:"error",message:n?"Student not found for this exam":"No students found for this exam"};const i=60*a;let u=0,d=0;for(const t of o){let s=!1;const n=Array.isArray(t.examSessions)?t.examSessions:[],r=n.length?n[n.length-1]:null;r&&String(r.examId)===String(e)&&("submitted"!==r.status&&"completed"!==r.status?(r.securityEvents.push({eventType:"exam",timestamp:new Date,details:a+"Added to time remaining"}),r.timeRemaining=(r.timeRemaining||0)+i,r.timeLimit=(r.timeLimit||0)+a,s=!0,u+=1,s&&await t.save()):d+=1)}if(!u)return{status:200,type:"info",message:"No active sessions were updated"};const c=[`${u} session${1===u?"":"s"} updated for ${n?"student":"students"}`];return d&&c.push(`${d} session${1===d?"":"s"} skipped (already completed)`),{status:200,type:"success",message:c.join(", ")}}catch(e){return{status:400,type:"error",message:e.message}}},updateTimeRemaining:async(e,t)=>{try{const e=await Student.findOne({_id:t.data.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};const s=e.examSessions[e.examSessions.length-1];return s?"in_progress"!==s.status?{status:400,type:"error",message:"Session is not in progress"}:(t.data.answerContent&&"auto_marked"!==t.data.examType&&(s.answerContent=t.data.answerContent,s.securityEvents.push({eventType:"exam",timestamp:new Date,details:"Answer content updated"})),s.timeRemaining=t.data.timeRemaining,await e.save(),{status:200,type:"success",message:"Time remaining updated successfully"}):{status:400,type:"error",message:"Session not found"}}catch(e){return{status:400,type:"error",message:e.message}}},pauseExam:async(e,t)=>{try{const e=await Student.findOne({_id:t.data.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};const s=e.examSessions[e.examSessions.length-1];return s?(s.status="paused",s.pausedAt=new Date,await e.save(),{status:200,type:"success",message:"Exam paused successfully"}):{status:400,type:"error",message:"Session not found"}}catch(e){return{status:400,type:"error",message:e.message}}},resumeExam:async(e,t)=>{try{const e=await Student.findOne({_id:t.data.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};const s=e.examSessions[e.examSessions.length-1];if(!s)return{status:400,type:"error",message:"Session not found"};if(t.data.resumeKey&&e.resumeKey!==t.data.resumeKey)return{status:400,type:"error",message:"Invalid resume key"};if(s.status="in_progress",s.resumedAt=new Date,s.pausedAt){const e=Math.floor(((new Date).getTime()-s.pausedAt.getTime())/1e3);s.totalPauseDuration=(s.totalPauseDuration||0)+e}return await e.save(),{status:200,type:"success",message:"Exam resumed successfully"}}catch(e){return{status:400,type:"error",message:e.message}}},updateStudent:async(e,t)=>{try{return await Student.findByIdAndUpdate(t.id,t.data,{new:!0,runValidators:!0})?{status:200,type:"success",message:"Student successfully updated"}:{status:400,type:"error",message:`Student with ID ${t.id} not found`}}catch(e){return{status:400,type:"error",message:e.message}}},blockStudent:async(e,t)=>{try{const e=await Student.findById(t.data.studentId);return e?(e.isBlocked=!0,e.blockReason=t.data.blockReason,e.blockedAt=new Date,await e.save(),{status:200,type:"success",message:"Student blocked successfully"}):{status:400,type:"error",message:"Student not found"}}catch(e){return{status:400,type:"error",message:e.message}}},unblockStudent:async(e,t)=>{try{const e=await Student.findById(t.studentId);return e?(e.isBlocked=!1,e.blockReason="",e.blockedAt=null,await e.save(),{status:200,type:"success",message:"Student unblocked successfully"}):{status:400,type:"error",message:"Student not found"}}catch(e){return{status:400,type:"error",message:e.message}}},deleteStudent:async(e,t)=>{try{return await Student.findByIdAndUpdate(t.id,{is_deleted:!0,date_deleted:Date.now()})?{status:200,type:"success",message:"Student successfully deleted"}:{status:400,type:"error",message:`Student with ID ${t.id} not found`}}catch(e){return{status:400,type:"error",message:e.message}}},deleteMultipleStudents:async(e,t)=>{try{return await Student.updateMany({_id:{$in:t.data},is_deleted:!1},{is_deleted:!0,date_deleted:Date.now()})?{status:200,type:"success",message:"Students successfully deleted"}:{status:400,type:"error",message:"Students not found"}}catch(e){return{status:400,type:"error",message:e.message}}},markAnswer:async(e,t)=>{try{const e=await Student.findOne({_id:t.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};const s=e.examSessions[e.examSessions.length-1];if(!s)return{status:400,type:"error",message:"Session not found"};const a=s.answers.id(t.answerId);if(!a)return{status:400,type:"error",message:"Answer not found"};s.securityEvents.push({eventType:"exam",timestamp:new Date,details:"Answer marked"}),a.pointsAwarded=t.pointsAwarded,a.feedback=t.feedback,a.markedAt=new Date,a.isCorrect=t.pointsAwarded===a.maxPoints;let n=0;return s.answers.forEach(e=>{n+=e.pointsAwarded||0}),s.totalScore=n,s.percentageScore=s.maxScore>0?n/s.maxScore*100:0,await e.save(),{status:200,type:"success",message:"Answer marked successfully"}}catch(e){return{status:400,type:"error",message:e.message}}},flagSessionForReview:async(e,t)=>{try{const e=await Student.findOne({_id:t.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};const s=e.examSessions[e.examSessions.length-1];return s?(s.flaggedForReview=!0,s.flagReason=t.reason,await e.save(),{status:200,type:"success",message:"Session flagged for review"}):{status:400,type:"error",message:"Session not found"}}catch(e){return{status:400,type:"error",message:e.message}}},addTeacherNotes:async(e,t)=>{try{const e=await Student.findOne({_id:t.studentId,is_deleted:!1});if(!e)return{status:400,type:"error",message:"Student not found"};const s=e.examSessions[e.examSessions.length-1];return s?(s.securityEvents.push({eventType:"exam",timestamp:new Date,details:"Teacher notes added"}),s.teacherNotes=t.notes,await e.save(),{status:200,type:"success",message:"Teacher notes added successfully"}):{status:400,type:"error",message:"Session not found"}}catch(e){return{status:400,type:"error",message:e.message}}},updateQuestionPoints:async(e,t,s)=>{try{requireAuth(s);const{studentId:e,points:a}=t.data;if(!e||!Array.isArray(a)||0===a.length)return{status:400,type:"error",message:"Invalid input: studentId and points array required"};const n=await Student.findOne({_id:e,is_deleted:!1});if(!n)return{status:400,type:"error",message:"Student not found"};const r=n.examSessions[n.examSessions.length-1];if(!r)return{status:400,type:"error",message:"Session not found"};if("submitted"!==r.status)return{status:400,type:"error",message:"Exam must be submitted before updating points"};let o=0,i=0,u=0;for(const e of a){const t=r.answers.find(t=>String(t.questionId)===String(e.questionId));t&&(t.pointsAwarded=e.pointsAwarded,t.isCorrect=e.pointsAwarded>0,o++)}return r.answers.forEach(e=>{i+=e.pointsAwarded||0,u+=e.maxPoints||0}),r.totalScore=i,r.maxScore=u,r.percentageScore=u>0?i/u*100:0,r.securityEvents.push({eventType:"exam",timestamp:new Date,details:`Points updated for ${o} question(s)`}),n.markModified("examSessions"),await n.save(),{status:200,type:"success",message:`Updated points for ${o} question(s). Total score: ${i}/${u}`}}catch(e){return{status:400,type:"error",message:e.message}}},resumeSubmittedExam:async(e,t,s)=>{try{requireAuth(s);const{studentId:e}=t,a=await Student.findOne({_id:e,is_deleted:!1});if(!a)return{status:400,type:"error",message:"Student not found"};const n=a.examSessions[a.examSessions.length-1];return n?"submitted"!==n.status?{status:400,type:"error",message:"Only submitted exams can be resumed"}:(n.status="in_progress",n.resumedAt=new Date,n.securityEvents.push({eventType:"exam",timestamp:new Date,details:"Exam resumed by staff member"}),a.markModified("examSessions"),await a.save(),{status:200,type:"success",message:"Exam resumed successfully"}):{status:400,type:"error",message:"Session not found"}}catch(e){return{status:400,type:"error",message:e.message}}},uploadAttachment:async(e,t,s)=>{try{const{studentId:e,questionId:a,examKey:n,imageBase64:r}=t.data,o=await Student.findOne({_id:e,is_deleted:!1});if(!o)return{status:400,type:"error",message:"Student not found"};const i=o.examSessions[o.examSessions.length-1];if(!i)return{status:400,type:"error",message:"No active exam session found"};const u=await Question.findById(a);if(!u)return{status:400,type:"error",message:"Question not found"};let d="";if(r)try{const t=await processBase64Upload(r,"attachments",ALLOWED_IMAGE_TYPES,`student-${e}-scan`);d=getAbsoluteUrl(s.req,`/images/attachments/${t}`)}catch(e){return{status:400,type:"error",message:"Failed to upload image"}}let c=i.answers.find(e=>String(e?.questionId)===String(a));return c?(d&&(c.attachments||(c.attachments=[]),c.attachments.push(d)),c.answeredAt=new Date):i.answers.push({questionId:a,attachments:d?[d]:[],answeredAt:new Date,questionType:u.type,questionText:u.question,questionPoints:u.points||u.totalPoints||0,maxPoints:u.points||u.totalPoints||0}),i.securityEvents.push({eventType:"attachment",timestamp:new Date,details:"Scanned attachment uploaded"}),await o.save(),{status:200,type:"success",message:"Attachment uploaded successfully"}}catch(e){return{status:400,type:"error",message:e.message}}}}};export default studentResolvers;