import mongoose from"mongoose";const{Schema:Schema}=mongoose,studentAnswerSchema=new Schema({questionId:{type:Schema.Types.ObjectId,ref:"Question",required:!0},questionType:{type:String,enum:["simple_answer","multiple_choice","match_answers","fill_gaps","free_text","grid","attachment"],required:!0},questionText:{type:String},questionOptions:Schema.Types.Mixed,questionCorrectAnswer:Schema.Types.Mixed,questionPoints:{type:Number},questionInstruction:{type:String},questionAttachments:[String],answer:Schema.Types.Mixed,isCorrect:{type:Boolean,default:null},pointsAwarded:{type:Number,default:0},maxPoints:{type:Number},timeSpent:{type:Number,default:0},attemptCount:{type:Number,default:1},markedAt:{type:Date},feedback:{type:String},attachments:[String],answeredAt:{type:Date,default:Date.now}},{_id:!0,timestamps:!0}),securityEventSchema=new Schema({eventType:{type:String,enum:["tab_switch","window_blur","fullscreen_exit","copy_attempt","paste_attempt","right_click","keyboard_shortcut","browser_extension_detected","multiple_tabs_detected","screen_recording_blocked","suspicious_activity","scores","exam"]},timestamp:{type:Date,default:Date.now},details:{type:String},ipAddress:{type:String},userAgent:{type:String}},{_id:!0}),examSessionSchema=new Schema({examId:{type:Schema.Types.ObjectId,ref:"Exam",required:!0},status:{type:String,enum:["not_started","in_progress","paused","completed","submitted","abandoned","timed_out","disqualified"],default:"not_started"},startTime:{type:Date},endTime:{type:Date},pausedAt:{type:Date},resumedAt:{type:Date},submittedAt:{type:Date},totalPauseDuration:{type:Number,default:0},timeLimit:{type:Number},timeRemaining:{type:Number},timeElapsed:{type:Number,default:0},answers:[studentAnswerSchema],answerContent:String,totalScore:{type:Number,default:0},maxScore:{type:Number,default:0},percentageScore:{type:Number,default:0},passed:{type:Boolean,default:!1},autoMarked:{type:Boolean,default:!1},manualMarkingRequired:{type:Boolean,default:!1},markingStatus:{type:String,enum:["pending","in_progress","completed"],default:"pending"},ipAddress:{type:String},ipAddresses:[{ip:String,timestamp:Date,location:String}],userAgent:{type:String},loginAttempts:{type:Number,default:0},lastLoginAttempt:{type:Date},accessGranted:{type:Boolean,default:!1},accessDeniedReason:{type:String},securityEvents:[securityEventSchema],tabSwitchCount:{type:Number,default:0},fullscreenExitCount:{type:Number,default:0},suspiciousActivityCount:{type:Number,default:0},screenRecordingEnabled:{type:Boolean,default:!1},screenRecordingUrl:{type:String},webcamRecordingUrl:{type:String},screenCaptures:[{url:String,timestamp:Date,reason:String}],examSettings:{shuffleQuestions:Boolean,shuffleAnswers:Boolean,allowSkip:Boolean,showResult:Boolean,lockdownMode:String,enabledTools:[String]},questionOrder:[{type:Schema.Types.ObjectId,ref:"Question"}],currentQuestionIndex:{type:Number,default:0},questionsAttempted:{type:Number,default:0},questionsSkipped:{type:Number,default:0},progressPercentage:{type:Number,default:0},teacherNotes:{type:String},flaggedForReview:{type:Boolean,default:!1},flagReason:{type:String},attemptNumber:{type:Number,default:1},isRetake:{type:Boolean,default:!1},previousAttemptId:{type:Schema.Types.ObjectId,ref:"Student"}},{_id:!0,timestamps:!0}),studentSchema=new Schema({examKey:{type:String,required:!0,index:!0},firstName:{type:String,trim:!0},lastName:{type:String,trim:!0},email:{type:String,index:!0},studentNumber:{type:String,trim:!0,index:!0},class:{type:String,trim:!0},telephone:{type:String,trim:!0},teacherName:{type:String,trim:!0},resumeKey:{type:String,trim:!0},exam:{type:Schema.Types.ObjectId,ref:"Exam",required:!0,index:!0},school:{type:Schema.Types.ObjectId,ref:"School"},examSessions:[examSessionSchema],currentSessionId:{type:Schema.Types.ObjectId},totalAttempts:{type:Number,default:0},bestScore:{type:Number,default:0},averageScore:{type:Number,default:0},lastAttemptDate:{type:Date},isActive:{type:Boolean,default:!0},isBlocked:{type:Boolean,default:!1},blockReason:{type:String},blockedAt:{type:Date},emailSent:{type:Boolean,default:!1},emailSentAt:{type:Date},is_deleted:{type:Boolean,default:!1},date_deleted:{type:Date,default:null}},{timestamps:!0});studentSchema.index({examKey:1,email:1}),studentSchema.index({exam:1,createdAt:-1}),studentSchema.index({school:1,is_deleted:1}),studentSchema.index({"examSessions.status":1}),studentSchema.index({"examSessions.examId":1});const Student=mongoose.model("Student",studentSchema);export default Student;