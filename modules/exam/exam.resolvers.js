import Exam from"./exam.model.js";import{processBase64Upload,ALLOWED_DOCUMENT_TYPES}from"../../utils/fileUpload.js";import Group from"../group/group.model.js";import{requireAuth,authStudent}from"../../middleware/auth.js";import{renderHtml}from"../../utils/pdfRender.js";function getAbsoluteUrl(e,t){const s=`${e.protocol||(e.secure?"https":"http")}://${e.get("host")}`;return new URL(t,s).href}async function generateExamPreviewPdf(e){const t=new(0,(await import("pdfkit")).default)({margin:50}),s=[];t.on("data",e=>s.push(e));const a=new Promise((e,a)=>{t.on("end",()=>{const t=Buffer.concat(s).toString("base64");e(`data:application/pdf;base64,${t}`)}),t.on("error",a)});if(t.fontSize(16).text(`${e?.school[0]?.name||""}`),t.fontSize(16).text(e.name||"Exam Preview",{underline:!0}),t.moveDown(),t.fontSize(12),"free_form"===e.examFormat){const s=e.freeFormContent||"No content available";renderHtml(t,s)}else if("auto_marked"===e.examFormat){const s=Array.isArray(e.questions)?e.questions:[],a=Array.isArray(e.sections)?e.sections:[],r=new Set,o=e=>{let t="";switch(e.type){case"simple_answer":Array.isArray(e.answers)&&e.answers.length&&(t=e.answers.join(", "));break;case"multiple_choice":if(Array.isArray(e.answerOptions)){t=e.answerOptions.filter(e=>e&&e.isCorrect).map(e=>e.content).filter(Boolean).join(", ")}break;case"match_answers":Array.isArray(e.matchPairs)&&(t=e.matchPairs.map(e=>`${e.option} â†’ ${e.match}`).join("\n"));break;case"fill_gaps":Array.isArray(e.gaps)&&(t=e.gaps.map((e,t)=>`Gap ${t+1}: ${(e.acceptedAnswers||[]).join(", ")}`).join("\n"));break;case"grid":if(Array.isArray(e.rows)&&Array.isArray(e.columns)){const s={};e.columns.forEach(e=>{e&&e.id&&(s[e.id]=e.label||e.id)});const a=[];e.rows.forEach(t=>{const r=t.label||t.id;Array.isArray(t.cells)&&t.cells.forEach((t,o)=>{if(t&&t.isCorrect){const t=e.columns[o]?.label||s[e.columns[o]?.id]||`Col ${o+1}`;a.push(`${r} / ${t}`)}})}),t=a.join("\n")}break;default:t=""}return t},n=(e,s)=>{t.moveDown(),t.fontSize(14).text(`Q${e}. `,{continued:!0}),t.fontSize(12);const a=(s.question||s.content||"").replace(/<[^>]*>/g,"");t.text(a);const r=o(s);if(r){t.moveDown(.5);const e=r.replace(/<[^>]*>/g,"");t.fontSize(12).text(`Answer: ${e}`)}};if(e.useSections&&a.length>0){for(const e of a){const a=Array.isArray(e?.questionIds)?e.questionIds:[];if(!a.length)continue;t.moveDown(),t.fontSize(13).text(String(e.title||""),{underline:!0}),t.fontSize(13).text(String(e.description.replace(/<[^>]*>/g,"")||""),{underline:!0}),t.moveDown(.5);let o=0;for(const e of a){const t=s.find(t=>String(t._id)===String(e));if(!t||r.has(String(e)))continue;if(t.mainQuestionId)continue;o+=1;const a=String(o);n(a,t),r.add(String(e));const i=s.filter(t=>String(t.mainQuestionId||"")===String(e));let u=0;for(const e of i){if(r.has(String(e._id)))continue;const t=`${a}${String.fromCharCode("b".charCodeAt(0)+u)}`;u+=1,n(t,e),r.add(String(e._id))}}}const e=s.filter(e=>!r.has(String(e._id)));if(e.length){t.moveDown(),t.fontSize(13).text("Additional Questions",{underline:!0}),t.moveDown(.5);let s=0;for(const t of e){if(t.mainQuestionId)continue;s+=1;const a=String(s);n(a,t),r.add(String(t._id));const o=e.filter(e=>String(e.mainQuestionId||"")===String(t._id));let i=0;for(const e of o){if(r.has(String(e._id)))continue;const t=`${a}${String.fromCharCode("b".charCodeAt(0)+i)}`;i+=1,n(t,e),r.add(String(e._id))}}}}else s.forEach((e,s)=>{if(!e.mainQuestionId){t.moveDown(),t.fontSize(14).text(`Q${s+1}. `,{continued:!0}),t.fontSize(12);const a=(e.question||e.content||"").replace(/<[^>]*>/g,"");t.text(a);const r=o(e);if(r){const e=r.replace(/<[^>]*>/g,"");t.moveDown(.5),t.fontSize(12).text(`Answer: ${e}`)}}})}else t.text("Unsupported exam format for preview");return t.end(),a}const examResolvers={Query:{exams:async(e,t,s)=>{try{const e=requireAuth(s),t=e?.school[0].id;return await Exam.find({is_deleted:!1,school:t}).populate("group").populate("school").populate("staff").populate("questions").sort({createdAt:-1})}catch(e){return{status:400,type:"error",message:e.message}}},getExamById:async(e,t,s)=>{try{requireAuth(s);const e=await Exam.findById(t.id).populate("staff").populate("group").populate("questions");return e||{status:400,type:"error",message:`Exam with ID ${t.id} not found`}}catch(e){return{status:400,type:"error",message:e.message}}},getExamByKey:async(e,t,s)=>{try{const e=await authStudent(s),a=await Exam.findOne({examKey:e?.examKey,is_deleted:!1}).populate("school").populate("questions");return a||{status:400,type:"error",message:`Exam with key ${t.examKey} not found`}}catch(e){return{status:400,type:"error",message:e.message}}},getExamByExamKeyRegister:async(e,t)=>{try{const e=await Exam.findOne({examKey:t.examKey,is_deleted:!1,status:"Active"}).populate("school");if(!e)return{status:400,type:"error",message:`Exam with key ${t.examKey} not found`};return{id:e.id,name:e.name,examKey:e.examKey,examFormat:e.examFormat,status:e.status,access:e.access,school:e.school[0]?.id||"",settings:e?.settings}}catch(e){return{status:400,type:"error",message:e.message}}},getExamsByFormat:async(e,t)=>{try{return await Exam.find({examFormat:t.examFormat,is_deleted:!1}).populate("questions").sort({createdAt:-1})}catch(e){return{status:400,type:"error",message:e.message}}},getExamsByStatus:async(e,t)=>{try{return await Exam.find({status:t.status,is_deleted:!1}).populate("school").populate("staff").populate("group").populate("questions").sort({createdAt:-1})}catch(e){return{status:400,type:"error",message:e.message}}}},Mutation:{addExam:async(e,t,s)=>{try{const{data:e}=t,a=requireAuth(s),r=a?.school[0].id,o=a?.id;if(e.pdfFileBase64)try{const t=`/images/pdfs/${await processBase64Upload(e.pdfFileBase64,"pdfs",ALLOWED_DOCUMENT_TYPES,"exam")}`;e.pdfFile=getAbsoluteUrl(s?.req,t),delete e.pdfFileBase64}catch(e){return{status:400,type:"error",message:`Failed to upload PDF: ${e.message}`}}if(!e.group||Array.isArray(e.group)&&0===e.group.length){const t=await Group.findOne({is_default:!0,is_deleted:!1,school:r});if(t)e.group=t._id;else{const t=new Group({name:"All Exams",school:r,color:"#4CAF50",is_default:!0});await t.save(),e.group=t._id}}e.staff=[o],e.school=[r],e.examKey=Math.random().toString(36).substring(2,8).toUpperCase();const n=new Exam({...e});return await n.save(),{status:200,type:"success",message:"Exam created successfully",data:n}}catch(e){return{status:400,type:"error",message:`Failed to create exam: ${e.message}`}}},updateExam:async(e,t,s)=>{try{const{data:e}=t,a=requireAuth(s);a?.school[0].id;if(e.pdfFileBase64&&""!==e.pdfFileBase64)try{const t=`/images/pdfs/${await processBase64Upload(e.pdfFileBase64,"pdfs",ALLOWED_DOCUMENT_TYPES,"exam")}`;e.pdfFile=getAbsoluteUrl(s?.req,t),delete e.pdfFileBase64}catch(e){return{status:400,type:"error",message:`Failed to upload PDF: ${e.message}`}}const r=await Exam.findByIdAndUpdate(t.id,{$set:e},{new:!0,runValidators:!0});return r?{status:200,type:"success",message:"Exam updated successfully",data:r}:{status:400,type:"error",message:`Exam with ID ${t.id} not found`}}catch(e){return{status:400,type:"error",message:`Failed to update exam: ${e.message}`}}},updateExamAccess:async(e,t,s)=>{try{const e=requireAuth(s);e?.school[0].id;return await Exam.findByIdAndUpdate(t.id,{$set:{access:t.access}},{new:!0,runValidators:!0})?{status:200,type:"success",message:`Exam access updated to ${t.access} successfully`}:{status:400,type:"error",message:`Exam with ID ${t.id} not found`}}catch(e){return{status:400,type:"error",message:`Failed to update exam access: ${e.message}`}}},duplicateExam:async(e,t,s)=>{try{const e=requireAuth(s),a=(e?.school[0].id,await Exam.findById(t.id));if(!a)return{status:400,type:"error",message:`Exam with ID ${t.id} not found`};const r=Math.random().toString(36).substring(2,8).toUpperCase(),o=new Exam({...a.toObject(),_id:void 0,name:`${a.name} (Copy)`,examKey:r,status:"Active",createdAt:void 0,updatedAt:void 0});return await o.save(),{status:200,type:"success",message:"Exam duplicated successfully"}}catch(e){return{status:400,type:"error",message:`Failed to duplicate exam: ${e.message}`}}},deleteExam:async(e,t,s)=>{try{const e=requireAuth(s);e?.school[0].id;return await Exam.findByIdAndUpdate(t.id,{is_deleted:!0,date_deleted:new Date},{new:!0})?{status:200,type:"success",message:"Exam deleted successfully"}:{status:400,type:"error",message:`Exam with ID ${t.id} not found`}}catch(e){return{status:400,type:"error",message:`Failed to delete exam: ${e.message}`}}},deleteMultipleExams:async(e,t,s)=>{try{const e=requireAuth(s),a=(e?.school[0].id,await Exam.updateMany({_id:{$in:t.data}},{is_deleted:!0,date_deleted:new Date}));return 0===a.modifiedCount?{status:400,type:"error",message:"No exams found to delete"}:{status:200,type:"success",message:`${a.modifiedCount} exam(s) deleted successfully`}}catch(e){return{status:400,type:"error",message:`Failed to delete exams: ${e.message}`}}},updateExamStatus:async(e,t,s)=>{try{const e=requireAuth(s),a=(e?.school[0].id,await Exam.findByIdAndUpdate(t.id,{status:t.status},{new:!0}));return a?{status:200,type:"success",message:"Exam status updated successfully",data:a}:{status:400,type:"error",message:`Exam with ID ${t.id} not found`}}catch(e){return{status:400,type:"error",message:`Failed to update exam status: ${e.message}`}}},updateMultipleExamsStatus:async(e,t,s)=>{try{const e=requireAuth(s),a=(e?.school[0].id,await Exam.updateMany({_id:{$in:t.data}},{status:t.status}));return 0===a.modifiedCount?{status:400,type:"error",message:"No exams found to update"}:{status:200,type:"success",message:`${a.modifiedCount} exam(s) status updated successfully`}}catch(e){return{status:400,type:"error",message:`Failed to update exams status: ${e.message}`}}},moveExamsToGroup:async(e,t,s)=>{try{const e=requireAuth(s),a=e?.school?.[0]?.id,{examIds:r,targetGroupId:o}=t.data||{};if(!Array.isArray(r)||0===r.length)return{status:400,type:"error",message:"Please select at least one exam"};if(!o)return{status:400,type:"error",message:"Target group is required"};const n=await Group.findOne({_id:o,is_deleted:!1});if(!n)return{status:400,type:"error",message:"Target group not found"};const i=await Exam.find({_id:{$in:r},is_deleted:!1});if(!i.length)return{status:400,type:"error",message:"No valid exams found to move"};let u=0;for(const e of i){const t=Array.isArray(e.school)?e.school:[e.school];(!a||t.some(e=>String(e)===String(a)))&&(e.group=[n._id],await e.save(),u+=1)}return u?{status:200,type:"success",message:`${u} exam${1===u?"":"s"} moved successfully`}:{status:400,type:"error",message:"No exams were moved. Please verify your selection."}}catch(e){return{status:400,type:"error",message:`Failed to move exams: ${e.message}`}}},addQuestionsToExam:async(e,t,s)=>{try{const e=requireAuth(s),a=(e?.school[0].id,await Exam.findByIdAndUpdate(t.examId,{$addToSet:{questions:{$each:t.questionIds}}},{new:!0}).populate("questions"));return a?{status:200,type:"success",message:"Questions added to exam successfully",data:a}:{status:400,type:"error",message:`Exam with ID ${t.examId} not found`}}catch(e){return{status:400,type:"error",message:`Failed to add questions: ${e.message}`}}},removeQuestionsFromExam:async(e,t,s)=>{try{const e=requireAuth(s),a=(e?.school[0].id,await Exam.findByIdAndUpdate(t.examId,{$pull:{questions:{$in:t.questionIds}}},{new:!0}).populate("questions"));return a?{status:200,type:"success",message:"Questions removed from exam successfully",data:a}:{status:400,type:"error",message:`Exam with ID ${t.examId} not found`}}catch(e){return{status:400,type:"error",message:`Failed to remove questions: ${e.message}`}}},handlePreviewExam:async(e,t,s)=>{try{requireAuth(s);const e=await Exam.findOne({_id:t.examId,is_deleted:!1}).populate("questions").populate("school");if(!e)return{status:400,type:"error",message:`Exam with ID ${t.examId} not found`};if("pdf"===e.examFormat)return e.pdfFile?{status:200,type:"success",message:"Preview generated successfully",data:e.pdfFile}:{status:400,type:"error",message:"No PDF file is associated with this exam"};if("free_form"!==e.examFormat&&"auto_marked"!==e.examFormat)return{status:400,type:"error",message:"Preview is only available for pdf, free_form, and auto_marked exams"};return{status:200,type:"success",message:"Preview generated successfully",data:await generateExamPreviewPdf(e)}}catch(e){return{status:400,type:"error",message:`Failed to generate exam preview: ${e.message}`}}}}};export default examResolvers;