import{requireAuth}from"../../middleware/auth.js";import Question from"./question.model.js";import ExcelJS from"exceljs";const questionResolvers={Query:{questions:async(e,t,s)=>{try{const e=requireAuth(s),t=e?.school[0].id;return await Question.find({school:t,is_deleted:!1}).populate("subject").populate("staff").sort({createdAt:-1})}catch(e){return{status:400,type:"error",message:e.message}}},getQuestionById:async(e,t,s)=>{try{const e=requireAuth(s),a=(e?.school[0].id,await Question.findOne({_id:t.id}).populate("subject").populate("staff"));return a||{status:400,type:"error",message:`Question with ID ${t.id} not found`}}catch(e){return{status:400,type:"error",message:e.message}}},getQuestionsByIds:async(e,t,s)=>{try{const e=requireAuth(s),a=(e?.school[0].id,await Question.find({_id:{$in:t.ids},is_deleted:!1,status:{$ne:"Inactive"}}).populate("subject").populate("staff")),r=new Map(a.map(e=>[e._id.toString(),e]));return t.ids.map(e=>r.get(e)).filter(e=>void 0!==e)}catch(e){return{status:400,type:"error",message:e.message}}},getQuestionsByType:async(e,t,s)=>{try{const e=requireAuth(s);e?.school[0].id;return await Question.find({type:t.type,is_deleted:!1}).populate("subject").sort({createdAt:-1})}catch(e){return{status:400,type:"error",message:e.message}}},getQuestionTags:async(e,t,s)=>{try{const e=requireAuth(s);e?.school[0].id;return await Question.distinct("tag").where("tag").ne("").exec()}catch(e){return{status:400,type:"error",message:e.message}}},getSubQuestions:async(e,t,s)=>{try{requireAuth(s);return await Question.find({mainQuestionId:t.mainQuestionId,is_deleted:!1}).populate("subject").populate("staff").sort({createdAt:1})}catch(e){return{status:400,type:"error",message:e.message}}},searchQuestions:async(e,t,s)=>{try{const e=requireAuth(s),a=e?.school[0].id;let r={school:a,is_deleted:!1};t.subject&&t.subject.length>0&&(r.subject={$in:t.subject}),t.tag&&t.tag.length>0&&(r.tag={$in:t.tag}),t.group_code&&(r.group_code=t.group_code),t.type&&t.type.length>0&&(r.type={$in:t.type}),t.difficulty&&t.difficulty.length>0&&(r.difficultyLevel={$in:t.difficulty}),r.status={$ne:"Inactive"};return await Question.find(r).populate("subject").populate("staff").sort({createdAt:-1})}catch(e){return{status:400,type:"error",message:e.message}}},getQuestionsInExcel:async(e,t,s)=>{try{const e=requireAuth(s),a=e?.school[0].id,r=t.count||10,i=await Question.distinct("type").where("school").equals(a).where("type").ne("information").where("is_deleted").equals(!1).exec();if(!i||0===i.length){const e=new ExcelJS.Workbook;e.addWorksheet("Questions").columns=[{header:"Question Type",key:"type",width:20},{header:"Question",key:"question",width:50},{header:"Difficulty",key:"difficultyLevel",width:15},{header:"Total Points",key:"totalPoints",width:15},{header:"Answer Options",key:"answerOptions",width:50}];const t=await e.xlsx.writeBuffer();return`data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${Buffer.from(t).toString("base64")}`}const o=[],n=Math.ceil(r/i.length);for(const e of i){const t=await Question.find({school:a,type:e,is_deleted:!1}).limit(n).exec();o.push(...t)}const u=o.slice(0,r),c=new ExcelJS.Workbook,d=c.addWorksheet("Questions");d.columns=[{header:"Question Type",key:"type",width:20},{header:"Question",key:"question",width:50},{header:"Difficulty",key:"difficultyLevel",width:15},{header:"Total Points",key:"totalPoints",width:15},{header:"Answer Options",key:"answerOptions",width:50}],u.forEach(e=>{let t="";e.answerOptions&&Array.isArray(e.answerOptions)&&e.answerOptions.length>0?t=e.answerOptions.map((e,t)=>`${t+1}. ${e.content||e.text||e} ${e.isCorrect?"(Correct)":""}`).join(" | "):e.answers&&Array.isArray(e.answers)&&e.answers.length>0?t=e.answers.join(", "):e.gaps&&Array.isArray(e.gaps)&&e.gaps.length>0?t=e.gaps.map(e=>`Gap: ${e.acceptedAnswers?.join(", ")}`).join(" | "):e.matchPairs&&Array.isArray(e.matchPairs)&&e.matchPairs.length>0&&(t=e.matchPairs.map(e=>`${e.option} -> ${e.match}`).join(" | ")),d.addRow({type:e.type,question:e.question?.replace(/<[^>]*>/g,"")||"",difficultyLevel:e.difficultyLevel||"",totalPoints:e.totalPoints||0,answerOptions:t})}),d.getRow(1).font={bold:!0},d.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4CAF50"}};const l=await c.xlsx.writeBuffer();return`data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${Buffer.from(l).toString("base64")}`}catch(e){return{status:400,type:"error",message:e.message}}},exportQuestionsToExcel:async(e,t,s)=>{try{const e=requireAuth(s),a=e?.school[0].id;let r={school:a};t.questionIds&&t.questionIds.length>0?r._id={$in:t.questionIds}:(t.searchTerm&&(r.$or=[{question:{$regex:t.searchTerm,$options:"i"}},{code:{$regex:t.searchTerm,$options:"i"}},{group_code:{$regex:t.searchTerm,$options:"i"}},{tag:{$regex:t.searchTerm,$options:"i"}}]),t.subject&&(r.subject=t.subject),t.difficulty&&(r.difficultyLevel=t.difficulty),t.tag&&(r.tag=t.tag),t.status&&("Inactive"===t.status?r.status="Inactive":"archive"===t.status?r.is_deleted=!0:"Active"===t.status&&(r.status="Active")));const i=await Question.find(r).populate("subject").sort({createdAt:-1}).exec();if(!i||0===i.length){const e=new ExcelJS.Workbook;e.addWorksheet("Questions").columns=[{header:"Code",key:"code",width:15},{header:"Question",key:"question",width:50},{header:"Type",key:"type",width:20},{header:"Subject",key:"subject",width:20},{header:"Tag",key:"tag",width:15},{header:"Difficulty",key:"difficultyLevel",width:15},{header:"Status",key:"status",width:15},{header:"Total Points",key:"totalPoints",width:15},{header:"Answer Options",key:"answerOptions",width:50}];const t=await e.xlsx.writeBuffer();return`data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${Buffer.from(t).toString("base64")}`}const o=new ExcelJS.Workbook,n=o.addWorksheet("Questions");n.columns=[{header:"Code",key:"code",width:15},{header:"Question",key:"question",width:50},{header:"Type",key:"type",width:20},{header:"Subject",key:"subject",width:20},{header:"Tag",key:"tag",width:15},{header:"Difficulty",key:"difficultyLevel",width:15},{header:"Status",key:"status",width:15},{header:"Total Points",key:"totalPoints",width:15},{header:"Answer Options",key:"answerOptions",width:50}],i.forEach(e=>{let t="";e.answerOptions&&Array.isArray(e.answerOptions)&&e.answerOptions.length>0?t=e.answerOptions.map((e,t)=>`${t+1}. ${e.content||e.text||e} ${e.isCorrect?"(Correct)":""}`).join(" | "):e.answers&&Array.isArray(e.answers)&&e.answers.length>0?t=e.answers.join(", "):e.gaps&&Array.isArray(e.gaps)&&e.gaps.length>0?t=e.gaps.map(e=>`Gap: ${e.acceptedAnswers?.join(", ")}`).join(" | "):e.matchPairs&&Array.isArray(e.matchPairs)&&e.matchPairs.length>0&&(t=e.matchPairs.map(e=>`${e.option} -> ${e.match}`).join(" | ")),n.addRow({code:e.code||"",question:e.question?.replace(/<[^>]*>/g,"")||"",type:e.type||"",subject:e.subject?.[0]?.title||e.subject?.title||"",tag:e.tag||"",difficultyLevel:e.difficultyLevel||"",status:e.status||"",totalPoints:e.totalPoints||0,answerOptions:t})}),n.getRow(1).font={bold:!0},n.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4CAF50"}};const u=await o.xlsx.writeBuffer();return`data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${Buffer.from(u).toString("base64")}`}catch(e){return{status:400,type:"error",message:e.message}}}},Mutation:{addQuestion:async(e,t,s)=>{try{const e=requireAuth(s),a=e?.school[0].id,r=e?.id;t.data.staff=r,t.data.school=a,t.data.status="Active",t.data.code=Math.random().toString(36).substring(2,8),(!t.data.subject||Array.isArray(t.data.subject)&&0===t.data.subject.length)&&delete t.data.subject;const i=new Question(t.data);return await i.save(),{status:200,type:"success",message:"Question successfully added"}}catch(e){return{status:400,type:"error",message:e.message}}},updateQuestion:async(e,t,s)=>{try{const e=requireAuth(s);e?.school[0].id;(!t.data.subject||Array.isArray(t.data.subject)&&0===t.data.subject.length)&&delete t.data.subject;return await Question.findByIdAndUpdate(t.id,t.data,{new:!0,runValidators:!0})?{status:200,type:"success",message:"Question successfully updated"}:{status:400,type:"error",message:`Question with ID ${t.id} not found`}}catch(e){return{status:400,type:"error",message:e.message}}},duplicateQuestion:async(e,t,s)=>{try{const e=requireAuth(s),a=(e?.school[0].id,await Question.findById(t.id));if(!a)return{status:400,type:"error",message:`Question with ID ${t.id} not found`};const r=a.toObject();delete r._id,delete r.createdAt,delete r.updatedAt;const i=Math.random().toString(36).substring(2,8);r.code=i,r.question&&(r.question=r.question+" (Copy)"),r.content&&(r.content=r.content+" (Copy)"),r.status="Active",r.is_deleted=!1,r.date_deleted=null;return{status:200,type:"success",message:"Question successfully duplicated",data:await Question.create(r)}}catch(e){return{status:400,type:"error",message:e.message}}},deleteQuestion:async(e,t,s)=>{try{const e=requireAuth(s);e?.school[0].id;return await Question.findByIdAndUpdate(t.id,{is_deleted:!0,date_deleted:Date.now()})?{status:200,type:"success",message:"Question successfully deleted"}:{status:400,type:"error",message:`Question with ID ${t.id} not found`}}catch(e){return{status:400,type:"error",message:e.message}}},importQuestionInExcel:async(e,t,s)=>{try{const e=requireAuth(s),a=e?.school[0].id,r=e?.id,{excelFile:i,group_code:o,subject:n,tag:u}=t.data;if(!i)return{status:400,type:"error",message:"No file provided"};const c=i.includes(",")?i.split(",")[1]:i,d=Buffer.from(c,"base64"),l=new ExcelJS.Workbook;await l.xlsx.load(d.buffer.slice(d.byteOffset,d.byteOffset+d.byteLength));const p=l.getWorksheet(1);if(!p)return{status:400,type:"error",message:"No worksheet found in Excel file"};const h=[];if(p.eachRow((e,t)=>{if(1===t)return;const s=e.getCell(1).value,i=e.getCell(5).value;let c;i&&(c="multiple_choice"===s?i.split(" | ").map(e=>{const t=Math.random().toString(36).substring(2,8),s=e.includes("(Correct)");return{id:t,content:e.replace(/^\d+\.\s*/,"").replace(/\s*\(Correct\)/,"").trim(),isCorrect:s}}):"simple_answer"===s?i.split(", ").map(e=>e.trim()):"fill_gaps"===s?i.split(" | ").map((e,t)=>({id:Math.random().toString(36).substring(2,8),text:`Gap ${t+1}`,acceptedAnswers:e.replace("Gap: ","").split(", ").map(e=>e.trim())})):"match_answers"===s?i.split(" | ").map(e=>{const t=Math.random().toString(36).substring(2,8),[s,a]=e.split(" -> ").map(e=>e.trim());return{id:t,option:s,match:a}}):i);const d={type:s,question:e.getCell(2).value,difficultyLevel:e.getCell(3).value,totalPoints:e.getCell(4).value,school:a,staff:r,status:"Active",code:Math.random().toString(36).substring(2,8),group_code:o,subject:n,tag:u};if("multiple_choice"===s){d.answerOptions=c;const e=c.filter(e=>e.isCorrect).length;d.selectionMode=e>1?"multiple":"single"}else"simple_answer"===s?d.answers=c:"fill_gaps"===s?d.gaps=c:"match_answers"===s?d.matchPairs=c:d.answerOptions=c;h.push(d)}),0===h.length)return{status:400,type:"error",message:"No questions found in Excel file"};const y=await Question.find({question:{$in:h.map(e=>e.question)},school:a,subject:n}),f=h.filter(e=>!y.some(t=>t.question===e.question));return{status:200,type:"success",message:`${(await Question.insertMany(f)).length} questions successfully imported`}}catch(e){return{status:400,type:"error",message:e.message}}},deleteMultipleQuestions:async(e,t,s)=>{try{const e=requireAuth(s);e?.school[0].id;return await Question.updateMany({_id:{$in:t.data},is_deleted:!1},{is_deleted:!0,date_deleted:Date.now()})?{status:200,type:"success",message:"Questions successfully deleted"}:{status:400,type:"error",message:"Questions not found"}}catch(e){return{status:400,type:"error",message:e.message}}},updateMultipleQuestionsStatus:async(e,t,s)=>{try{const e=requireAuth(s);e?.school[0].id;return await Question.updateMany({_id:{$in:t.data}},{status:t.status})?{status:200,type:"success",message:`Questions status updated to ${t.status}`}:{status:400,type:"error",message:"Questions not found"}}catch(e){return{status:400,type:"error",message:e.message}}}}};export default questionResolvers;